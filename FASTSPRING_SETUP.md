# üöÄ Gu√≠a de Configuraci√≥n de FastSpring

## ‚ö†Ô∏è IMPORTANTE: Protecci√≥n Anti-Fraude

**Stripe cerr√≥ tu cuenta por alto riesgo de disputas**. FastSpring tambi√©n puede cerrarte la cuenta si detectan patrones sospechosos. Este setup incluye protecciones esenciales.

---

## üìã Requisitos Previos

1. **Cuenta de FastSpring creada** ‚úÖ (Ya la tienes)
2. **Producto configurado**: `iqmind-premium-access`
3. **Storefront configurado**: Popup Storefront
4. **Credenciales API**: Username y Password

---

## üîë 1. Configurar Variables de Entorno

A√±ade estas variables a tu `.env.local` y a **Vercel**:

```bash
# FastSpring - P√∫blico (Frontend)
NEXT_PUBLIC_FASTSPRING_STOREFRONT=tu-store.onfastspring.com/popup-storefront

# FastSpring - Privado (Backend)
FASTSPRING_API_USERNAME=tu_api_username
FASTSPRING_API_PASSWORD=tu_api_password
FASTSPRING_WEBHOOK_SECRET=tu_webhook_secret

# Configuraci√≥n del proveedor de pago
PAYMENT_PROVIDER=fastspring
```

### üìç D√≥nde encontrar las credenciales:

1. **Storefront URL**:
   - FastSpring Dashboard ‚Üí Storefronts ‚Üí Tu storefront ‚Üí Copy URL
   - Ejemplo: `mystore.onfastspring.com/popup-storefront`

2. **API Credentials**:
   - FastSpring Dashboard ‚Üí Integrations ‚Üí API Credentials
   - Create New Credentials si no tienes
   - Guarda Username y Password

3. **Webhook Secret** (opcional):
   - FastSpring Dashboard ‚Üí Integrations ‚Üí Webhooks ‚Üí Create
   - Usa HMAC signature para mayor seguridad

---

## üèóÔ∏è 2. Configurar Producto en FastSpring

### Crear el Producto

1. Ir a **Products** en FastSpring Dashboard
2. Create New Product:
   - **Product Path**: `iqmind-premium-access` (exacto)
   - **Display Name**: "IQMind Premium Access"
   - **Fulfillment Type**: "Licensed Product" o "Service"

### Configurar Precio

1. **Setup Fee** (cargo inicial):
   - Amount: **‚Ç¨0.50**
   - Description: "Test Result Unlock"

2. **Recurring Subscription**:
   - **Trial Period**: 2 d√≠as
   - **Price**: ‚Ç¨9.99/mes
   - **Billing Frequency**: Monthly

3. **Trial Behavior**:
   - ‚úÖ Charge setup fee immediately
   - ‚úÖ Start trial after setup fee
   - ‚úÖ Auto-convert to paid after trial

### Configurar Cancelaciones

- ‚úÖ Allow customer cancellation
- ‚úÖ Immediate cancellation (or end of period)
- ‚úÖ Full transparency

---

## üîó 3. Configurar Webhooks

1. Ir a **Integrations ‚Üí Webhooks** en FastSpring
2. Create New Webhook:
   - **URL**: `https://tu-dominio.com/api/fastspring-webhook`
   - **Events** a suscribir:
     - ‚úÖ `order.completed`
     - ‚úÖ `subscription.activated`
     - ‚úÖ `subscription.charge.completed`
     - ‚úÖ `subscription.charge.failed`
     - ‚úÖ `subscription.canceled`
     - ‚úÖ `subscription.deactivated`
     - ‚úÖ `return.created`

3. **Security** (recomendado):
   - Enable HMAC signature
   - Guardar el secret en `FASTSPRING_WEBHOOK_SECRET`

---

## üóÑÔ∏è 4. Configurar Base de Datos

A√±ade las configuraciones de FastSpring a la tabla `site_config`:

```sql
-- Cambiar proveedor de pago a FastSpring
INSERT INTO site_config (key, value, description) 
VALUES ('payment_provider', 'fastspring', 'Payment provider: stripe, fastspring, or lemonsqueezy')
ON CONFLICT (key) DO UPDATE SET value = 'fastspring';

-- Configuraci√≥n de FastSpring
INSERT INTO site_config (key, value, description) 
VALUES 
  ('fastspring_storefront', 'tu-store.onfastspring.com/popup-storefront', 'FastSpring Storefront URL'),
  ('fastspring_api_username', 'tu_api_username', 'FastSpring API Username'),
  ('fastspring_api_password', 'tu_api_password', 'FastSpring API Password'),
  ('fastspring_webhook_secret', 'tu_webhook_secret', 'FastSpring Webhook Secret (optional)'),
  ('fastspring_product_path', 'iqmind-premium-access', 'FastSpring Product Path')
ON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value;
```

**O usar el panel de administraci√≥n**:
- Ir a `/admin` en tu app
- Configurar FastSpring desde ah√≠

---

## üß™ 5. Testing

### Test Mode

FastSpring tiene modo test integrado:

1. En Dashboard ‚Üí Settings ‚Üí Test Data
2. Enable Test Mode
3. Usar tarjetas de prueba:
   - **Visa**: `4111 1111 1111 1111`
   - **Mastercard**: `5555 5555 5555 4444`
   - CVV: cualquier 3 d√≠gitos
   - Fecha: cualquier fecha futura

### Test del Flujo Completo

```bash
# 1. Hacer un test de IQ en tu app
# 2. Llegar al checkout
# 3. Usar email de prueba: test@example.com
# 4. Completar pago con tarjeta de prueba
# 5. Verificar webhook recibido
# 6. Verificar usuario creado en BD
# 7. Verificar email enviado
```

---

## üõ°Ô∏è 6. Sistema Anti-Fraude (CR√çTICO)

El sistema anti-fraude est√° activo por defecto. Verifica que est√© funcionando:

### Protecciones Implementadas

1. **Tiempo del test**:
   - M√≠nimo: 3 minutos (180 segundos)
   - M√°ximo: 1 hora (3600 segundos)

2. **L√≠mites de compra**:
   - 1 compra por email
   - 2 compras por IP

3. **Emails temporales bloqueados**:
   - tempmail.com, mailinator.com, yopmail.com, etc.

4. **Detecci√≥n de bots**:
   - 40+ respuestas correctas = bot
   - 80%+ respuestas iguales = bot

5. **Tracking de IPs**:
   - M√°ximo 3 tests por IP/d√≠a
   - M√°ximo 5 tests por IP/semana

### Ajustar L√≠mites

Edita `/lib/fraud-detection.ts` para ajustar:

```typescript
const FRAUD_CONFIG = {
  maxTestsPerIP: 3,              // Cambiar si es muy restrictivo
  minTimeToComplete: 180,        // Aumentar si detectas m√°s bots
  maxPurchasesPerEmail: 1,       // Mantener en 1
  // ...
}
```

### Monitorear Intentos Fraudulentos

Los intentos bloqueados se registran en logs:

```bash
# Ver logs en Vercel
vercel logs

# Buscar:
‚ö†Ô∏è [FRAUD] Intento sospechoso detectado
```

---

## üìä 7. Dashboard de Admin

Accede al panel de admin para monitorear:

- `/admin` (requiere email de admin configurado)

### M√©tricas Importantes

- **Ratio de disputas**: Debe ser < 0.75%
- **Ratio de reembolsos**: Debe ser < 5%
- **Ratio de conversi√≥n**: Test ‚Üí Pago
- **Usuarios activos vs cancelados**

---

## üö® 8. Prevenir Cierre de Cuenta

### Acciones Inmediatas

1. **Monitorear disputas diariamente**
2. **Responder a disputas en < 24h**
3. **Pol√≠tica de reembolsos clara** (14 d√≠as)
4. **Mejorar descripci√≥n del producto**
5. **A√±adir FAQ en checkout**

### Red Flags para FastSpring

‚ö†Ô∏è **FastSpring cerrar√° tu cuenta si**:
- Ratio de disputas > 1%
- Reembolsos excesivos (> 10%)
- Productos no entregados
- Descripci√≥n enga√±osa
- Violaci√≥n de t√©rminos

### Buenas Pr√°cticas

‚úÖ **HACER**:
- Descripci√≥n clara del servicio
- Trial period transparente
- Cancelaci√≥n f√°cil
- Soporte r√°pido
- Email de bienvenida con instrucciones

‚ùå **NO HACER**:
- Ocultar cargos recurrentes
- Dificultar cancelaciones
- Ignorar solicitudes de soporte
- Marketing enga√±oso
- Vender a menores

---

## üîÑ 9. Migraci√≥n desde Stripe

### Usuarios Existentes

Si tienes usuarios con Stripe activo:

```sql
-- NO MIGRAR usuarios existentes autom√°ticamente
-- Dejar que terminen su ciclo en Stripe
-- Nuevos usuarios ir√°n a FastSpring

-- Ver usuarios activos en Stripe:
SELECT email, subscription_status, trial_end_date 
FROM users 
WHERE subscription_status IN ('trial', 'active')
AND subscription_id LIKE 'sub_%';  -- IDs de Stripe empiezan con sub_
```

### Dual Payment Setup (Opcional)

Puedes mantener ambos temporalmente:

```typescript
// En checkout/page.tsx
const provider = userHasStripeSubscription 
  ? 'stripe' 
  : 'fastspring'
```

---

## üì± 10. Testing en Producci√≥n

### Checklist Pre-Launch

- [ ] Variables de entorno configuradas en Vercel
- [ ] Webhook URL configurada en FastSpring
- [ ] Producto activo en FastSpring
- [ ] Test de pago completado exitosamente
- [ ] Email de bienvenida recibido
- [ ] Usuario creado en BD con acceso
- [ ] Sistema anti-fraude activo
- [ ] Logs de Vercel monitoreados

### First 24 Hours

1. **Monitorear cada venta**
2. **Verificar webhooks llegan**
3. **Verificar emails se env√≠an**
4. **Revisar logs de fraude**
5. **Responder soporte inmediato**

---

## üÜò Troubleshooting

### El checkout no carga

```bash
# Verificar en consola del navegador:
# Error: "storefront not found"
‚Üí Revisar NEXT_PUBLIC_FASTSPRING_STOREFRONT

# Error: "product not found"
‚Üí Verificar que product path = 'iqmind-premium-access'
```

### Webhooks no llegan

```bash
# 1. Verificar URL en FastSpring Dashboard
# 2. Verificar logs de Vercel:
vercel logs --follow

# 3. Test webhook manualmente:
curl -X POST https://tu-dominio.com/api/fastspring-webhook \
  -H "Content-Type: application/json" \
  -d '{"events":[{"type":"order.completed","data":{"id":"test"}}]}'
```

### Usuario no recibe email

```bash
# Verificar configuraci√≥n de email en /lib/email-service.ts
# Verificar RESEND_API_KEY en variables de entorno
# Ver logs de Resend Dashboard
```

### Pago se procesa pero no da acceso

```bash
# 1. Verificar que webhook lleg√≥:
vercel logs | grep "fastspring-webhook"

# 2. Verificar usuario en BD:
SELECT * FROM users WHERE email = 'test@example.com';

# 3. Verificar subscription_id guardado
```

---

## üìû Soporte

### FastSpring Support

- Email: support@fastspring.com
- Dashboard: Help ‚Üí Submit Ticket
- Documentaci√≥n: https://fastspring.com/docs

### Recursos

- API Docs: https://fastspring.com/docs/api
- Builder SDK: https://fastspring.com/docs/popup-storefronts
- Webhooks: https://fastspring.com/docs/webhooks

---

## ‚úÖ Checklist Final

Antes de activar FastSpring en producci√≥n:

- [ ] Credenciales configuradas
- [ ] Producto configurado con trial de 2 d√≠as
- [ ] Webhooks configurados y probados
- [ ] Sistema anti-fraude activo
- [ ] Emails de bienvenida funcionando
- [ ] Panel de admin accesible
- [ ] Test completo realizado
- [ ] Monitoreo de disputas configurado
- [ ] Pol√≠tica de reembolsos actualizada
- [ ] T√©rminos y condiciones actualizados (mencionar FastSpring)

---

## üéØ Pr√≥ximos Pasos

1. **Configurar credenciales** en Vercel
2. **Configurar producto** en FastSpring Dashboard
3. **Configurar webhooks** con URL de producci√≥n
4. **Hacer test completo** en modo test
5. **Activar en producci√≥n**
6. **Monitorear primeras 24h intensivamente**

---

¬øNecesitas ayuda? Revisa los logs:

```bash
# Logs del servidor
vercel logs --follow

# Logs del navegador
Console ‚Üí buscar "FastSpring" o "checkout"
```

**¬°Buena suerte! üöÄ**

