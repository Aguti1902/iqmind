# üìß Configuraci√≥n de Emails - SendGrid

## üéØ Resumen

Sistema completo de emails autom√°ticos para todo el flujo de usuario en IQmind.

---

## üìã Emails Implementados

### 1. **Bienvenida** (Al iniciar test)
- **Trigger:** Usuario inicia el test
- **Contenido:** Mensaje de bienvenida y tips

### 2. **Test Completado** (Resultado estimado)
- **Trigger:** Usuario completa el test sin pagar
- **Contenido:** CI estimado + incentivo para pagar 0,50‚Ç¨

### 3. **Checkout Abandonado** (Recordatorio)
- **Trigger:** Usuario inicia checkout pero no completa pago
- **Contenido:** Recordatorio + incentivo para completar

### 4. **Pago Exitoso** (Confirmaci√≥n)
- **Trigger:** Usuario paga 0,50‚Ç¨ exitosamente
- **Contenido:** Confirmaci√≥n + resultado completo + acceso premium

### 5. **Trial Iniciado** (Bienvenida Premium)
- **Trigger:** Suscripci√≥n con trial activada
- **Contenido:** Bienvenida a premium + funciones disponibles + fecha fin trial

### 6. **Trial Termina Ma√±ana** (Recordatorio)
- **Trigger:** 1 d√≠a antes de que termine el trial
- **Contenido:** Recordatorio + opciones (continuar/cancelar)

### 7. **Suscripci√≥n Activada** (Despu√©s del trial)
- **Trigger:** Trial termina y se cobra primer pago mensual
- **Contenido:** Confirmaci√≥n de suscripci√≥n activa

### 8. **Pago Mensual Exitoso** (Cobro recurrente)
- **Trigger:** Cobro mensual exitoso (19,99‚Ç¨)
- **Contenido:** Confirmaci√≥n de pago + recibo

### 9. **Pago Fallido** (Problemas de cobro)
- **Trigger:** Intento de cobro fallido
- **Contenido:** Alerta + instrucciones para actualizar m√©todo de pago
- **L√≠mite:** 3 intentos antes de cancelar suscripci√≥n

### 10. **Suscripci√≥n Cancelada** (Confirmaci√≥n)
- **Trigger:** Usuario cancela suscripci√≥n
- **Contenido:** Confirmaci√≥n + fecha hasta la que tiene acceso

---

## üîß Configuraci√≥n de SendGrid

### **Paso 1: Crear cuenta en SendGrid**

1. Ve a: https://signup.sendgrid.com/
2. Crea cuenta con: `support@iqmind.io`
3. Verifica email

### **Paso 2: Obtener API Key**

1. Ve a: https://app.sendgrid.com/settings/api_keys
2. Clic en **"Create API Key"**
3. Nombre: `IQmind Production`
4. Permisos: **Full Access**
5. **Copia la API Key** (solo se muestra una vez)

### **Paso 3: Verificar Dominio**

1. Ve a: https://app.sendgrid.com/settings/sender_auth/domains
2. Clic en **"Authenticate Your Domain"**
3. Selecciona proveedor DNS: **Other**
4. Copia los registros DNS que te da SendGrid
5. Agrega esos registros en **DonDominio** (donde tienes `iqmind.io`)
6. Espera verificaci√≥n (puede tardar 24-48 horas)

### **Paso 4: Configurar en Vercel**

1. Ve a: https://vercel.com/dashboard
2. Selecciona proyecto `iqmind`
3. Ve a **Settings ‚Üí Environment Variables**
4. Agrega:
   ```
   Name: SENDGRID_API_KEY
   Value: SG.xxxxx (la API Key que copiaste)
   ```
5. Marca como **Production**, **Preview** y **Development**
6. Clic en **Save**

### **Paso 5: Redeploy**

1. En Vercel Dashboard, ve a **Deployments**
2. Clic en los 3 puntos del √∫ltimo deploy
3. Clic en **"Redeploy"**
4. Espera que termine

---

## üìß C√≥mo Usar el Sistema de Emails

### **Desde el C√≥digo:**

```typescript
// Ejemplo: Enviar email de bienvenida
const response = await fetch('/api/send-email', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    type: 'welcome',
    email: 'usuario@example.com',
    userName: 'Juan',
    lang: 'es',
  }),
})
```

### **Tipos de Email Disponibles:**

```typescript
type: 'welcome'                  // Bienvenida al iniciar test
type: 'testCompleted'            // Test completado (sin pagar)
type: 'checkoutAbandoned'        // Checkout abandonado
type: 'paymentSuccess'           // Pago exitoso (0,50‚Ç¨)
type: 'trialStarted'             // Trial iniciado
type: 'trialEndingTomorrow'      // Trial termina ma√±ana
type: 'subscriptionActivated'    // Suscripci√≥n activada
type: 'monthlyPaymentSuccess'    // Pago mensual exitoso
type: 'paymentFailed'            // Pago fallido
type: 'subscriptionCancelled'    // Suscripci√≥n cancelada
```

### **Par√°metros Requeridos por Tipo:**

```typescript
// welcome
{ type: 'welcome', email, userName, lang }

// testCompleted
{ type: 'testCompleted', email, userName, lang, estimatedIQ: number }

// checkoutAbandoned
{ type: 'checkoutAbandoned', email, userName, lang }

// paymentSuccess
{ type: 'paymentSuccess', email, userName, lang, iq: number }

// trialStarted
{ type: 'trialStarted', email, userName, lang, trialEndDate: string }

// trialEndingTomorrow
{ type: 'trialEndingTomorrow', email, userName, lang }

// subscriptionActivated
{ type: 'subscriptionActivated', email, userName, lang }

// monthlyPaymentSuccess
{ type: 'monthlyPaymentSuccess', email, userName, lang, amount: number }

// paymentFailed
{ type: 'paymentFailed', email, userName, lang, attempt: number }

// subscriptionCancelled
{ type: 'subscriptionCancelled', email, userName, lang, accessUntil: string }
```

---

## üéØ Integraci√≥n en el Flujo

### **1. Test Iniciado** ‚Üí Enviar email de bienvenida

**En:** `app/[lang]/test/page.tsx`

```typescript
// Cuando el usuario inicia el test
useEffect(() => {
  const sendWelcomeEmail = async () => {
    if (userEmail) {
      await fetch('/api/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'welcome',
          email: userEmail,
          userName: userName || 'Usuario',
          lang: lang,
        }),
      })
    }
  }
  sendWelcomeEmail()
}, [userEmail])
```

### **2. Test Completado** ‚Üí Enviar resultado estimado

**En:** `app/[lang]/test/page.tsx`

```typescript
// Cuando el usuario completa el test
const handleCompleteTest = async () => {
  // ... c√≥digo existente ...
  
  // Enviar email con resultado estimado
  await fetch('/api/send-email', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      type: 'testCompleted',
      email: userEmail,
      userName: userName || 'Usuario',
      lang: lang,
      estimatedIQ: estimatedIQ,
    }),
  })
  
  // Redirigir a checkout
  router.push(`/${lang}/checkout`)
}
```

### **3. Checkout Abandonado** ‚Üí Recordatorio

**En:** `app/[lang]/checkout/page.tsx`

```typescript
// Si el usuario abandona el checkout, enviar email despu√©s de 1 hora
useEffect(() => {
  const timer = setTimeout(() => {
    // Verificar si el pago no se complet√≥
    const paymentCompleted = localStorage.getItem('paymentCompleted')
    if (!paymentCompleted && userEmail) {
      fetch('/api/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'checkoutAbandoned',
          email: userEmail,
          userName: userName || 'Usuario',
          lang: lang,
        }),
      })
    }
  }, 60 * 60 * 1000) // 1 hora

  return () => clearTimeout(timer)
}, [])
```

### **4. Pago Exitoso** ‚Üí Confirmaci√≥n + Resultado

**En:** `app/[lang]/checkout/page.tsx`

```typescript
// Despu√©s de confirmar el pago
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault()
  
  // ... c√≥digo de pago existente ...
  
  // Si el pago es exitoso
  if (paymentIntent.status === 'succeeded') {
    // Enviar email de confirmaci√≥n
    await fetch('/api/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'paymentSuccess',
        email: email,
        userName: userName || 'Usuario',
        lang: lang,
        iq: userIQ,
      }),
    })
    
    // Redirigir a resultado
    router.push(`/${lang}/resultado`)
  }
}
```

### **5. Trial Iniciado** ‚Üí Bienvenida Premium

**En:** `app/api/create-subscription/route.ts`

```typescript
// Despu√©s de crear la suscripci√≥n con trial
const subscription = await stripe.subscriptions.create({
  // ... configuraci√≥n existente ...
})

// Enviar email de trial iniciado
await fetch(`${process.env.NEXT_PUBLIC_BASE_URL || 'https://iqmind.io'}/api/send-email`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    type: 'trialStarted',
    email: customerEmail,
    userName: customerName || 'Usuario',
    lang: 'es', // O detectar del contexto
    trialEndDate: new Date(subscription.trial_end * 1000).toLocaleDateString('es-ES'),
  }),
})
```

### **6. Trial Termina Ma√±ana** ‚Üí Recordatorio

**Crear job programado** (usar cron job o servicio externo)

```typescript
// Ejemplo con cron job diario
// Verificar suscripciones que terminan ma√±ana
const subscriptions = await stripe.subscriptions.list({
  status: 'trialing',
})

const tomorrow = new Date()
tomorrow.setDate(tomorrow.getDate() + 1)

for (const sub of subscriptions.data) {
  if (sub.trial_end && new Date(sub.trial_end * 1000).toDateString() === tomorrow.toDateString()) {
    // Enviar email de recordatorio
    await fetch('/api/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'trialEndingTomorrow',
        email: sub.customer.email,
        userName: sub.customer.name || 'Usuario',
        lang: 'es',
      }),
    })
  }
}
```

### **7. Suscripci√≥n Activada** ‚Üí Confirmaci√≥n

**En:** Webhook de Stripe

```typescript
// app/api/webhook/route.ts
case 'customer.subscription.updated':
  const subscription = event.data.object as Stripe.Subscription
  
  // Si el trial termin√≥ y ahora est√° activa
  if (subscription.status === 'active' && !subscription.trial_end) {
    await fetch('/api/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'subscriptionActivated',
        email: customer.email,
        userName: customer.name || 'Usuario',
        lang: 'es',
      }),
    })
  }
  break
```

### **8. Pago Mensual Exitoso** ‚Üí Recibo

**En:** Webhook de Stripe

```typescript
// app/api/webhook/route.ts
case 'invoice.payment_succeeded':
  const invoice = event.data.object as Stripe.Invoice
  
  // Si es un pago recurrente (no el inicial)
  if (invoice.billing_reason === 'subscription_cycle') {
    await fetch('/api/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'monthlyPaymentSuccess',
        email: invoice.customer_email,
        userName: customer.name || 'Usuario',
        lang: 'es',
        amount: invoice.amount_paid / 100, // Convertir de centavos
      }),
    })
  }
  break
```

### **9. Pago Fallido** ‚Üí Alerta

**En:** Webhook de Stripe

```typescript
// app/api/webhook/route.ts
case 'invoice.payment_failed':
  const invoice = event.data.object as Stripe.Invoice
  
  // Contar intentos fallidos
  const attempt = invoice.attempt_count
  
  await fetch('/api/send-email', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      type: 'paymentFailed',
      email: invoice.customer_email,
      userName: customer.name || 'Usuario',
      lang: 'es',
      attempt: attempt,
    }),
  })
  
  // Si es el 3er intento, cancelar suscripci√≥n
  if (attempt >= 3) {
    await stripe.subscriptions.update(invoice.subscription as string, {
      cancel_at_period_end: true,
    })
  }
  break
```

### **10. Suscripci√≥n Cancelada** ‚Üí Confirmaci√≥n

**En:** Webhook de Stripe o API de cancelaci√≥n

```typescript
// app/api/webhook/route.ts
case 'customer.subscription.deleted':
  const subscription = event.data.object as Stripe.Subscription
  
  await fetch('/api/send-email', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      type: 'subscriptionCancelled',
      email: customer.email,
      userName: customer.name || 'Usuario',
      lang: 'es',
      accessUntil: new Date(subscription.current_period_end * 1000).toLocaleDateString('es-ES'),
    }),
  })
  break
```

---

## üß™ Testing

### **Probar Emails en Desarrollo:**

```bash
# Sin SendGrid configurado, los emails se loguean en consola
npm run dev
```

### **Probar Emails en Producci√≥n:**

1. Configura SendGrid (pasos arriba)
2. Hace un test de pago
3. Verifica que recibes los emails

### **Ver Logs de SendGrid:**

1. Ve a: https://app.sendgrid.com/activity
2. Ver√°s todos los emails enviados
3. Puedes ver si fueron entregados, rebotaron, etc.

---

## üìä Estad√≠sticas

SendGrid Dashboard te mostrar√°:
- Emails enviados
- Tasa de apertura
- Tasa de clicks
- Emails rebotados
- Emails marcados como spam

---

## üîê Seguridad

- ‚úÖ API Key en variables de entorno (nunca en c√≥digo)
- ‚úÖ Verificaci√≥n de dominio (previene spam)
- ‚úÖ Rate limiting de SendGrid (100 emails/d√≠a gratis)
- ‚úÖ Templates HTML seguros (sin XSS)

---

## üí∞ Costos

**SendGrid Free Tier:**
- 100 emails/d√≠a gratis
- Ilimitado para siempre

**Si necesitas m√°s:**
- Essentials: $19.95/mes (40,000 emails)
- Pro: $89.95/mes (100,000 emails)

---

## üéØ Pr√≥ximos Pasos

1. ‚úÖ Crear cuenta en SendGrid
2. ‚úÖ Obtener API Key
3. ‚úÖ Verificar dominio `iqmind.io`
4. ‚úÖ Agregar `SENDGRID_API_KEY` en Vercel
5. ‚úÖ Redeploy
6. ‚úÖ Integrar triggers en el c√≥digo
7. ‚úÖ Probar flujo completo

---

## üìù Notas

- Los emails se env√≠an desde `support@iqmind.io`
- Todos los emails son responsive (m√≥vil + desktop)
- Todos los emails tienen versi√≥n en espa√±ol e ingl√©s
- Los emails incluyen botones de acci√≥n (CTAs)
- Los emails tienen footer con info de contacto

---

**¬øNecesitas ayuda con alg√∫n paso?** üìß

