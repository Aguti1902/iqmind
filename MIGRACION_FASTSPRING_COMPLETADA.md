# ‚úÖ Migraci√≥n a FastSpring - COMPLETADA

## üì¶ Archivos Creados/Modificados

### Frontend
- ‚úÖ `/app/[lang]/checkout/checkout-fastspring.tsx` - Componente de checkout con FastSpring SDK
- ‚úÖ `/app/[lang]/checkout/page.tsx` - Router actualizado para soportar FastSpring

### Backend APIs
- ‚úÖ `/app/api/fastspring-process-order/route.ts` - Procesa √≥rdenes completadas
- ‚úÖ `/app/api/fastspring-webhook/route.ts` - Maneja webhooks de FastSpring
- ‚úÖ `/app/api/validate-before-payment/route.ts` - Sistema anti-fraude

### Librer√≠as
- ‚úÖ `/lib/fastspring-config.ts` - Configuraci√≥n de FastSpring desde BD
- ‚úÖ `/lib/fraud-detection.ts` - Sistema completo de detecci√≥n de fraude

### Documentaci√≥n
- ‚úÖ `FASTSPRING_SETUP.md` - Gu√≠a completa de configuraci√≥n
- ‚úÖ `FASTSPRING_QUICK_START.md` - Gu√≠a r√°pida de 5 minutos

---

## üîë Qu√© Necesitas Configurar AHORA

### 1. Variables de Entorno en Vercel

```bash
NEXT_PUBLIC_FASTSPRING_STOREFRONT=tu-store.onfastspring.com/popup-storefront
FASTSPRING_API_USERNAME=tu_api_username
FASTSPRING_API_PASSWORD=tu_api_password
FASTSPRING_WEBHOOK_SECRET=tu_webhook_secret  # opcional pero recomendado
PAYMENT_PROVIDER=fastspring
```

### 2. En FastSpring Dashboard

**Producto** (`iqmind-premium-access`):
- Setup Fee: ‚Ç¨0.50 (inmediato)
- Trial: 2 d√≠as (gratis)
- Recurring: ‚Ç¨9.99/mes (despu√©s del trial)

**Webhook**:
- URL: `https://iqmind.mobi/api/fastspring-webhook`
- Events: todos los de subscription + order.completed

### 3. En tu Base de Datos

```sql
-- Cambiar a FastSpring
UPDATE site_config SET value = 'fastspring' WHERE key = 'payment_provider';

-- O usa el panel admin en /admin
```

---

## üõ°Ô∏è Sistema Anti-Fraude ACTIVO

**CR√çTICO**: Este sistema es esencial dado tu historial con Stripe.

### Protecciones Implementadas

‚úÖ **Tiempo del test**:
- M√≠nimo: 3 minutos (180 seg) ‚Üí bloquea bots
- M√°ximo: 1 hora ‚Üí evita tests abandonados

‚úÖ **L√≠mites de compra**:
- 1 compra por email
- 2 compras por IP/d√≠a

‚úÖ **Emails temporales bloqueados**:
- tempmail, guerrillamail, mailinator, yopmail, etc.

‚úÖ **Detecci√≥n de bots**:
- 40+ respuestas correctas = bloqueado
- 80%+ respuestas iguales = bloqueado
- Patr√≥n sospechoso = bloqueado

‚úÖ **Tracking de IPs**:
- M√°ximo 3 tests por IP/d√≠a
- M√°ximo 5 tests por IP/semana

### Monitoreo de Fraude

Los intentos bloqueados se registran en logs:

```bash
vercel logs --follow | grep "FRAUD"
```

---

## ‚ö†Ô∏è ADVERTENCIAS CR√çTICAS

### FastSpring tambi√©n puede cerrar tu cuenta si:

1. **Ratio de disputas > 0.75%**
2. **Ratio de reembolsos > 5-10%**
3. **Detecci√≥n de fraude o bots**
4. **Marketing enga√±oso**
5. **No cumplir con trial transparente**

### Acciones para Prevenir Cierre

‚úÖ **HACER INMEDIATAMENTE**:
1. Monitorear disputas DIARIAMENTE
2. Responder soporte en < 24h
3. Pol√≠tica de reembolsos clara (14 d√≠as)
4. Email de bienvenida con instrucciones claras
5. Descripci√≥n transparente en checkout
6. A√±adir FAQ en p√°gina de checkout

‚ùå **NUNCA HACER**:
1. Ocultar que es suscripci√≥n recurrente
2. Dificultar cancelaciones
3. Ignorar solicitudes de reembolso
4. Marketing agresivo o enga√±oso
5. Permitir bots o tests fraudulentos

---

## üöÄ Pasos Inmediatos (ORDEN)

### D√≠a 1: Setup (HOY)

1. ‚è∞ **Configurar variables en Vercel** (5 min)
2. ‚è∞ **Configurar producto en FastSpring** (10 min)
3. ‚è∞ **Configurar webhook** (5 min)
4. ‚è∞ **Deploy a producci√≥n** (5 min)
5. ‚è∞ **Test completo** (10 min)

**Total: 35 minutos para estar operativo**

### D√≠a 2-7: Monitoreo Intensivo

- Revisar logs cada 6 horas
- Verificar cada venta manualmente
- Responder soporte inmediato
- Ajustar sistema anti-fraude si es muy estricto

### Semana 2+: Monitoreo Regular

- Revisar m√©tricas diarias:
  - Ratio de conversi√≥n (test ‚Üí pago)
  - Ratio de cancelaci√≥n
  - Ratio de disputas (CR√çTICO: < 0.75%)
  - Ratio de reembolsos (< 5%)

---

## üìä M√©tricas a Monitorear

### Dashboard de Admin (`/admin`)

M√©tricas clave:
- **Usuarios nuevos/d√≠a**
- **Conversi√≥n test ‚Üí pago** (objetivo: > 30%)
- **Disputas** (CR√çTICO: mantener < 0.75%)
- **Reembolsos** (mantener < 5%)
- **Cancelaciones** (normal: 20-40%)

### FastSpring Dashboard

- Revenue
- Subscriptions activas
- Churn rate
- Failed payments

---

## üîÑ Flujo Completo (Verificar)

### Usuario hace test ‚Üí Pago ‚Üí Acceso

1. **Usuario completa test** (m√≠nimo 3 min)
   - Sistema anti-fraude valida
   - Si es sospechoso ‚Üí BLOQUEADO

2. **Click en "Pagar ‚Ç¨0.50"**
   - Abre popup de FastSpring
   - Procesa ‚Ç¨0.50 inmediatamente
   - Guarda m√©todo de pago

3. **FastSpring webhook ‚Üí order.completed**
   - Llama a `/api/fastspring-process-order`
   - Crea usuario en BD
   - Genera contrase√±a
   - Guarda resultado del test
   - Env√≠a email de bienvenida

4. **Trial de 2 d√≠as comienza**
   - Usuario tiene acceso full
   - `subscription_status = 'trial'`
   - `trial_end_date = +2 d√≠as`

5. **Despu√©s de 2 d√≠as ‚Üí FastSpring cobra ‚Ç¨9.99**
   - Webhook: `subscription.charge.completed`
   - Actualiza `subscription_status = 'active'`
   - Env√≠a email de confirmaci√≥n

6. **Cada mes ‚Üí Cobra ‚Ç¨9.99 autom√°ticamente**
   - Webhook cada pago
   - Extiende `access_until`

7. **Si cancela ‚Üí mantiene acceso hasta fin de per√≠odo**
   - Webhook: `subscription.canceled`
   - `subscription_status = 'cancelled'`
   - `access_until = fecha de fin de per√≠odo`

---

## üÜò Troubleshooting R√°pido

### Checkout no carga
```javascript
// Console del navegador
Error: storefront not found
‚Üí Revisar NEXT_PUBLIC_FASTSPRING_STOREFRONT
```

### Webhook no llega
```bash
# 1. Verificar URL en FastSpring
# 2. Ver logs
vercel logs --follow

# 3. Test manual
curl -X POST https://iqmind.mobi/api/fastspring-webhook \
  -H "Content-Type: application/json" \
  -d '{"events":[{"type":"order.completed","data":{"id":"test"}}]}'
```

### Usuario no recibe email
```bash
# Ver logs de Resend
# Verificar RESEND_API_KEY configurada
vercel env ls
```

### Pago procesado pero sin acceso
```sql
-- Verificar usuario en BD
SELECT * FROM users WHERE email = 'email@usuario.com';

-- Deber√≠a tener:
-- subscription_status = 'trial'
-- subscription_id = orden de FastSpring
-- trial_end_date = +2 d√≠as
```

---

## üí∞ Costos

### FastSpring Fees

- **Standard**: 5.9% + $0.95 por transacci√≥n
- **Plus**: 8.9% (incluye m√°s servicios)

### Comparaci√≥n con Stripe

| | Stripe | FastSpring |
|---|---|---|
| **Fee** | 2.9% + ‚Ç¨0.30 | 5.9% + $0.95 |
| **Merchant of Record** | ‚ùå No | ‚úÖ S√≠ |
| **Gesti√≥n de impuestos** | Manual | Autom√°tica |
| **Riesgo de cierre** | Alto (ya cerrada) | Medio |
| **Soporte global** | Bueno | Excelente |

**Costo extra = 3% m√°s**, pero evitas:
- C√°lculo manual de IVA
- Registro fiscal en cada pa√≠s
- Disputas (FastSpring las gestiona)
- Compliance (GDPR, PCI-DSS)

---

## ‚úÖ Checklist Pre-Launch

Antes de activar en producci√≥n, verificar:

- [ ] Variables de entorno en Vercel
- [ ] Producto configurado en FastSpring
- [ ] Webhook configurado y probado
- [ ] Test completo realizado (test ‚Üí pago ‚Üí acceso ‚Üí email)
- [ ] Sistema anti-fraude activo
- [ ] Logs monitoreables
- [ ] Panel admin accesible
- [ ] Pol√≠tica de reembolsos actualizada
- [ ] T√©rminos y condiciones mencionan FastSpring
- [ ] Email de soporte configurado (support@iqmind.mobi)

---

## üìû Recursos

### FastSpring
- Dashboard: https://dashboard.fastspring.com
- Docs: https://fastspring.com/docs
- Support: support@fastspring.com

### Tu Setup
- App: https://iqmind.mobi
- Admin: https://iqmind.mobi/admin
- Logs: `vercel logs --follow`

---

## üéØ Siguiente Paso

**AHORA**: Configura las variables de entorno en Vercel y FastSpring Dashboard.

Sigue: `FASTSPRING_QUICK_START.md` (5 minutos)

**¬°Ya casi est√°s! üöÄ**

---

## üí° Tips Finales

1. **Primera semana**: Monitorear como halc√≥n
2. **Responder soporte r√°pido**: < 24h siempre
3. **Ser transparente**: trial + recurring bien explicado
4. **Facilitar cancelaci√≥n**: 2 clicks m√°ximo
5. **Ofrecer reembolsos**: dentro de 14 d√≠as sin preguntas

**Recuerda**: FastSpring prefiere vendedores √©ticos y transparentes. Si mantienes bajas disputas y reembolsos, no tendr√°s problemas.

---

_Migraci√≥n completada el: ${new Date().toLocaleDateString()}_

_Documentaci√≥n generada por: AI Assistant_

