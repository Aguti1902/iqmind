<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>Pago Seguro - Sipay</title>
  
  <style>
    * { box-sizing: border-box; }
    html, body { 
      margin: 0;
      padding: 0;
      width: 100%; 
      min-height: 100%;
      background: #f9fafb;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    body { 
      padding: 8px;
    }
    
    /* IMPORTANTE: Ocultar el bot√≥n launcher de Sipay seg√∫n documentaci√≥n oficial */
    .fastpay-btn {
      display: none !important;
    }
    
    /* Asegurar que el iframe de Sipay sea responsive */
    iframe {
      width: 100% !important;
      max-width: 100% !important;
      min-height: 480px;
      border: none !important;
    }
    
    /* Loading state */
    #loading {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }
    #loading .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Debug panel */
    #debug {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1f2937;
      color: #10b981;
      font-family: monospace;
      font-size: 11px;
      padding: 8px;
      max-height: 120px;
      overflow-y: auto;
      display: none; /* Ocultar en producci√≥n */
    }
  </style>
  
  <script>
    // ============================================
    // 1. CALLBACK - Definir ANTES de cargar Sipay
    // ============================================
    function onFastPayDone(response) {
      log('‚úÖ CALLBACK EJECUTADO!');
      log('Response: ' + JSON.stringify(response));
      
      // Enviar al padre (Next.js)
      if (window.parent && window.parent !== window) {
        var message = {
          type: 'sipay_fastpay_done',
          request_id: response && response.request_id ? response.request_id : null,
          payload: response
        };
        window.parent.postMessage(message, '*');
        log('üì§ PostMessage enviado: ' + JSON.stringify(message));
      } else {
        log('‚ö†Ô∏è No hay ventana padre');
        alert('Pago completado! request_id: ' + (response && response.request_id ? response.request_id : 'N/A'));
      }
    }
    
    // Exponer globalmente
    window.onFastPayDone = onFastPayDone;
    
    // ============================================
    // DEBUG LOGGER
    // ============================================
    function log(msg) {
      console.log('[Sipay] ' + msg);
      var debugEl = document.getElementById('debug');
      if (debugEl) {
        debugEl.style.display = 'block';
        debugEl.innerHTML += msg + '<br>';
        debugEl.scrollTop = debugEl.scrollHeight;
      }
    }
  </script>
</head>
<body>
  <!-- Loading indicator -->
  <div id="loading">
    <div class="spinner"></div>
    <div>Cargando formulario de pago seguro...</div>
  </div>

  <!-- Bot√≥n de Sipay (se ocultar√° con CSS pero es necesario para la librer√≠a) -->
  <button
    type="button"
    class="fastpay-btn"
    data-key="clicklabsdigital"
    data-amount="50"
    data-currency="EUR"
    data-template="v4"
    data-lang="es"
    data-callback="onFastPayDone"
    data-cardholdername="false"
    data-autosave="true"
  >Pagar</button>

  <!-- Debug panel -->
  <div id="debug"></div>

  <!-- Cargar SDK de Sipay (sandbox) -->
  <script src="https://sandbox.sipay.es/fpay/v1/static/bundle/fastpay.js"></script>
  
  <script>
    // ============================================
    // 2. CONFIGURAR PAR√ÅMETROS DESDE URL
    // ============================================
    (function() {
      var params = new URLSearchParams(window.location.search);
      var btn = document.querySelector('.fastpay-btn');
      
      if (btn) {
        var key = params.get('key') || 'clicklabsdigital';
        var amount = params.get('amount') || '50';
        var currency = params.get('currency') || 'EUR';
        var template = params.get('template') || 'v4';
        var lang = params.get('lang') || 'es';
        
        btn.setAttribute('data-key', key);
        btn.setAttribute('data-amount', amount);
        btn.setAttribute('data-currency', currency);
        btn.setAttribute('data-template', template);
        btn.setAttribute('data-lang', lang);
        
        log('‚öôÔ∏è Config: key=' + key + ', amount=' + amount + ', currency=' + currency);
      }
    })();
    
    // ============================================
    // 3. AUTO-CLICK SEG√öN DOCUMENTACI√ìN SIPAY
    // Recomendaciones UI/UX: click() para auto-renderizar
    // ============================================
    function autoOpenSipay() {
      var btn = document.querySelector('.fastpay-btn');
      if (btn) {
        log('üñ±Ô∏è Ejecutando click en bot√≥n Sipay...');
        
        // A√±adir listener para ver si el click se ejecuta
        btn.addEventListener('click', function(e) {
          log('üëÜ Click event disparado en bot√≥n');
        }, { once: true });
        
        // Click program√°tico
        btn.click();
        
        log('‚úì Click ejecutado');
      } else {
        log('‚ùå Bot√≥n .fastpay-btn no encontrado');
      }
    }
    
    // Esperar a que fastpay.js est√© listo
    function waitForSipayAndOpen() {
      log('‚è≥ Esperando a fastpay.js...');
      
      // Dar tiempo a que fastpay.js se inicialice
      setTimeout(function() {
        autoOpenSipay();
        
        // Ocultar loading despu√©s de un momento
        setTimeout(function() {
          var loading = document.getElementById('loading');
          if (loading) {
            // Verificar si hay iframe de Sipay
            var iframes = document.querySelectorAll('iframe');
            log('üìä Iframes encontrados: ' + iframes.length);
            
            if (iframes.length > 0) {
              loading.style.display = 'none';
              log('‚úÖ Formulario Sipay cargado correctamente');
            } else {
              loading.innerHTML = '<div style="color:#ef4444;">Error al cargar el formulario. <button onclick="location.reload()" style="color:#3b82f6;text-decoration:underline;border:none;background:none;cursor:pointer;">Reintentar</button></div>';
              log('‚ùå No se encontr√≥ iframe de Sipay');
            }
          }
        }, 1500);
      }, 500);
    }
    
    // Iniciar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', waitForSipayAndOpen);
    } else {
      waitForSipayAndOpen();
    }
    
    // ============================================
    // 4. LISTENER PARA MENSAJES DE SIPAY
    // ============================================
    window.addEventListener('message', function(event) {
      // Solo loguear mensajes relevantes (no de extensiones)
      if (event.data && typeof event.data === 'object') {
        if (event.data.request_id || (event.origin && event.origin.includes('sipay'))) {
          log('üì® Message de ' + event.origin + ': ' + JSON.stringify(event.data).substring(0, 100));
          
          // Si tiene request_id, llamar al callback
          if (event.data.request_id) {
            log('üéâ request_id recibido via postMessage!');
            onFastPayDone(event.data);
          }
        }
      }
    });
    
    log('üöÄ Script inicializado');
  </script>
</body>
</html>
