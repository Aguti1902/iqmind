/**
 * Sistema de Reembolso Preventivo (Alternativa a ChargeBlast para FastSpring)
 * 
 * Detecta clientes de alto riesgo ANTES de que inicien disputas
 * y toma acciones preventivas autom√°ticas
 */

import { db } from './database-postgres'
import { sendEmail } from './email-service'

// Configuraci√≥n del sistema
const PREVENTIVE_CONFIG = {
  // Auto-reembolso si el cliente no usa el servicio
  autoRefundIfNoUsage: true,
  daysWithoutUsageForRefund: 7,        // Si no inicia sesi√≥n en 7 d√≠as ‚Üí reembolso
  
  // Auto-reembolso si detectamos email de queja
  autoRefundOnComplaint: true,
  complaintKeywords: [
    'fraude', 'fraud', 'scam', 'estafa', 
    'no autorizad', 'unauthorized', 'no reconozco',
    'i did not', 'nunca compr√©', 'never purchased',
    'cancel', 'cancelar', 'reembolso', 'refund'
  ],
  
  // Auto-reembolso si es usuario high-risk
  autoRefundHighRisk: true,
  highRiskIndicators: {
    temporaryEmail: true,              // Email temporal
    vpnDetected: true,                 // VPN o proxy
    testTooFast: true,                 // Test < 3 min
    multipleAttempts: true,            // M√∫ltiples intentos de pago
  },
  
  // L√≠mites de reembolso autom√°tico
  maxAutoRefundAmount: 0.50,           // Solo auto-reembolsar pagos iniciales de ‚Ç¨0.50
  maxAutoRefundsPerDay: 5,             // M√°ximo 5 reembolsos auto por d√≠a
  
  // Notificaciones
  notifyOnAutoRefund: true,
  alertEmails: [
    process.env.ADMIN_EMAIL || 'support@iqmind.mobi'
  ]
}

export interface RiskSignal {
  type: 'no_usage' | 'complaint_email' | 'high_risk_user' | 'failed_cancellation' | 'suspicious_pattern'
  severity: 'low' | 'medium' | 'high' | 'critical'
  description: string
  timestamp: string
  userId: string
  userEmail: string
  metadata?: any
}

export interface PreventiveAction {
  action: 'auto_refund' | 'send_proactive_email' | 'flag_for_review' | 'auto_cancel'
  reason: string
  riskSignals: RiskSignal[]
  userId: string
  userEmail: string
  subscriptionId?: string
  orderId?: string
  amount?: number
  executed: boolean
  executedAt?: string
}

/**
 * Detectar se√±ales de riesgo de un usuario
 */
export async function detectRiskSignals(userId: string): Promise<RiskSignal[]> {
  const signals: RiskSignal[] = []
  
  try {
    const user = await db.getUserById(userId)
    if (!user) return signals
    
    const now = new Date()
    
    // 1. SE√ëAL: No ha usado el servicio (sin logins)
    if (user.lastLogin) {
      const lastLoginDate = new Date(user.lastLogin)
      const daysSinceLogin = Math.floor((now.getTime() - lastLoginDate.getTime()) / (1000 * 60 * 60 * 24))
      
      if (daysSinceLogin >= PREVENTIVE_CONFIG.daysWithoutUsageForRefund) {
        signals.push({
          type: 'no_usage',
          severity: 'high',
          description: `Usuario no ha iniciado sesi√≥n en ${daysSinceLogin} d√≠as`,
          timestamp: now.toISOString(),
          userId: user.id,
          userEmail: user.email,
          metadata: { daysSinceLogin, lastLogin: user.lastLogin }
        })
      }
    }
    
    // 2. SE√ëAL: Email temporal (high-risk)
    const emailDomain = user.email.split('@')[1]?.toLowerCase()
    const temporaryDomains = [
      'tempmail.com', 'guerrillamail.com', 'mailinator.com', 
      '10minutemail.com', 'yopmail.com', 'throwaway.email'
    ]
    
    if (temporaryDomains.includes(emailDomain)) {
      signals.push({
        type: 'high_risk_user',
        severity: 'critical',
        description: `Email temporal detectado: ${emailDomain}`,
        timestamp: now.toISOString(),
        userId: user.id,
        userEmail: user.email,
        metadata: { emailDomain }
      })
    }
    
    // 3. SE√ëAL: Usuario en trial pero no ha hecho tests (sospechoso)
    if (user.subscriptionStatus === 'trial' && (!user.testResults || user.testResults.length === 0)) {
      const createdAt = new Date(user.createdAt)
      const daysSinceCreation = Math.floor((now.getTime() - createdAt.getTime()) / (1000 * 60 * 60 * 24))
      
      if (daysSinceCreation >= 2) {
        signals.push({
          type: 'suspicious_pattern',
          severity: 'medium',
          description: `Usuario en trial ${daysSinceCreation} d√≠as sin hacer tests`,
          timestamp: now.toISOString(),
          userId: user.id,
          userEmail: user.email,
          metadata: { daysSinceCreation, testResults: 0 }
        })
      }
    }
    
    // 4. SE√ëAL: Test sospechoso (demasiado r√°pido)
    if (user.testResults && user.testResults.length > 0) {
      const lastTest = user.testResults[0]
      if (lastTest.timeElapsed < 180) { // < 3 minutos
        signals.push({
          type: 'high_risk_user',
          severity: 'high',
          description: `Test completado en ${lastTest.timeElapsed}s (posible bot)`,
          timestamp: now.toISOString(),
          userId: user.id,
          userEmail: user.email,
          metadata: { timeElapsed: lastTest.timeElapsed }
        })
      }
    }
    
    return signals
  } catch (error) {
    console.error('Error detectando se√±ales de riesgo:', error)
    return signals
  }
}

/**
 * Determinar acci√≥n preventiva basada en se√±ales de riesgo
 */
export async function determinePreventiveAction(signals: RiskSignal[]): Promise<PreventiveAction | null> {
  if (signals.length === 0) return null
  
  const criticalSignals = signals.filter(s => s.severity === 'critical')
  const highSignals = signals.filter(s => s.severity === 'high')
  
  const firstSignal = signals[0]
  
  // ACCI√ìN CR√çTICA: Auto-reembolso
  if (criticalSignals.length > 0 || highSignals.length >= 2) {
    return {
      action: 'auto_refund',
      reason: `${criticalSignals.length + highSignals.length} se√±ales de alto riesgo detectadas`,
      riskSignals: signals,
      userId: firstSignal.userId,
      userEmail: firstSignal.userEmail,
      executed: false
    }
  }
  
  // ACCI√ìN ALTA: Email proactivo ofreciendo ayuda
  if (highSignals.length === 1) {
    return {
      action: 'send_proactive_email',
      reason: 'Se√±al de riesgo alto detectada',
      riskSignals: signals,
      userId: firstSignal.userId,
      userEmail: firstSignal.userEmail,
      executed: false
    }
  }
  
  // ACCI√ìN MEDIA: Marcar para revisi√≥n manual
  return {
    action: 'flag_for_review',
    reason: 'Se√±ales de riesgo medio detectadas',
    riskSignals: signals,
    userId: firstSignal.userId,
    userEmail: firstSignal.userEmail,
    executed: false
  }
}

/**
 * Ejecutar reembolso preventivo via FastSpring API
 */
export async function executePreventiveRefund(
  orderId: string, 
  reason: string,
  userEmail: string
): Promise<boolean> {
  try {
    console.log(`üîÑ [PREVENTIVE] Ejecutando reembolso preventivo para orden ${orderId}`)
    
    const username = process.env.FASTSPRING_API_USERNAME
    const password = process.env.FASTSPRING_API_PASSWORD
    
    if (!username || !password) {
      console.error('‚ùå [PREVENTIVE] Credenciales de FastSpring no configuradas')
      return false
    }
    
    // FastSpring API para crear reembolso
    const response = await fetch(
      `https://api.fastspring.com/orders/${orderId}/returns`,
      {
        method: 'POST',
        headers: {
          'Authorization': `Basic ${Buffer.from(`${username}:${password}`).toString('base64')}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          reason: reason,
          comment: `Reembolso preventivo autom√°tico: ${reason}`
        })
      }
    )
    
    if (!response.ok) {
      console.error('‚ùå [PREVENTIVE] Error en API de FastSpring:', response.status)
      return false
    }
    
    const result = await response.json()
    console.log('‚úÖ [PREVENTIVE] Reembolso ejecutado:', result)
    
    // Notificar por email
    await notifyPreventiveRefund(orderId, userEmail, reason)
    
    return true
  } catch (error) {
    console.error('‚ùå [PREVENTIVE] Error ejecutando reembolso:', error)
    return false
  }
}

/**
 * Enviar email proactivo al cliente ofreciendo ayuda
 */
export async function sendProactiveEmail(userEmail: string, userName: string, signals: RiskSignal[]): Promise<void> {
  console.log(`üìß [PREVENTIVE] Enviando email proactivo a ${userEmail}`)
  
  const mainReason = signals[0].description
  
  try {
    await sendEmail({
      to: userEmail,
      subject: '¬øNecesitas ayuda con tu cuenta de IQmind?',
      html: `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>¬øPodemos ayudarte?</title>
        </head>
        <body style="font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px;">
          <div style="max-width: 600px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px;">
            <h2 style="color: #031C43;">Hola ${userName},</h2>
            
            <p style="color: #4a5568; font-size: 16px; line-height: 1.6;">
              Notamos que a√∫n no has aprovechado tu acceso premium a IQmind.
            </p>
            
            <p style="color: #4a5568; font-size: 16px; line-height: 1.6;">
              ¬øHay algo con lo que podamos ayudarte?
            </p>
            
            <div style="background-color: #e6f7f7; border-left: 4px solid #218B8E; padding: 15px; margin: 20px 0;">
              <h3 style="color: #218B8E; margin-top: 0;">üéÅ Opciones:</h3>
              <ul style="color: #4a5568; margin: 0;">
                <li>Si no est√°s satisfecho, podemos hacer un <strong>reembolso completo</strong></li>
                <li>Si tienes dudas sobre c√≥mo usar el servicio, estamos aqu√≠ para ayudarte</li>
                <li>Puedes cancelar en cualquier momento desde tu cuenta</li>
              </ul>
            </div>
            
            <p style="color: #4a5568; font-size: 16px; line-height: 1.6;">
              Simplemente responde a este email y resolveremos cualquier problema.
            </p>
            
            <div style="text-align: center; margin: 30px 0;">
              <a href="${process.env.NEXT_PUBLIC_APP_URL}/cuenta" 
                 style="display: inline-block; background: #218B8E; color: white; padding: 14px 28px; text-decoration: none; border-radius: 6px; font-weight: bold;">
                Acceder a mi Cuenta
              </a>
            </div>
            
            <p style="color: #718096; font-size: 14px; text-align: center;">
              Equipo IQmind<br>
              support@iqmind.mobi
            </p>
          </div>
        </body>
        </html>
      `
    })
    
    console.log('‚úÖ [PREVENTIVE] Email proactivo enviado')
  } catch (error) {
    console.error('‚ùå [PREVENTIVE] Error enviando email proactivo:', error)
  }
}

/**
 * Notificar al admin sobre reembolso preventivo
 */
async function notifyPreventiveRefund(orderId: string, userEmail: string, reason: string): Promise<void> {
  for (const adminEmail of PREVENTIVE_CONFIG.alertEmails) {
    try {
      await sendEmail({
        to: adminEmail,
        subject: `üõ°Ô∏è Reembolso Preventivo Ejecutado - ${userEmail}`,
        html: `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Reembolso Preventivo</title>
          </head>
          <body style="font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px;">
            <div style="max-width: 600px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px; border-left: 5px solid #10b981;">
              <h2 style="color: #059669;">üõ°Ô∏è Reembolso Preventivo Ejecutado</h2>
              
              <div style="background-color: #d1fae5; padding: 15px; border-radius: 6px; margin: 20px 0;">
                <p style="margin: 0; color: #065f46;">
                  <strong>Orden:</strong> ${orderId}<br>
                  <strong>Cliente:</strong> ${userEmail}<br>
                  <strong>Raz√≥n:</strong> ${reason}<br>
                  <strong>Acci√≥n:</strong> Reembolso autom√°tico preventivo
                </p>
              </div>
              
              <p style="color: #4a5568;">
                Este reembolso se ejecut√≥ autom√°ticamente para prevenir una posible disputa.
              </p>
              
              <p style="color: #059669; font-weight: bold;">
                ‚úÖ Prevenci√≥n exitosa: Este cliente NO contar√° en el ratio de disputas.
              </p>
              
              <a href="${process.env.NEXT_PUBLIC_APP_URL}/admin/disputes" 
                 style="display: inline-block; background: #10b981; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin-top: 20px;">
                Ver Dashboard
              </a>
            </div>
          </body>
          </html>
        `
      })
    } catch (error) {
      console.error('Error notificando reembolso preventivo:', error)
    }
  }
}

/**
 * Monitoreo autom√°tico de usuarios de alto riesgo (ejecutar cada 6 horas)
 */
export async function scanHighRiskUsers(): Promise<void> {
  console.log('üîç [PREVENTIVE] Escaneando usuarios de alto riesgo...')
  
  try {
    // Obtener usuarios en trial o activos
    const config = await db.getAllConfig()
    
    // En producci√≥n, obtendr√≠as todos los usuarios de la BD
    // Por ahora, esto es un placeholder
    
    // TODO: Implementar query para obtener usuarios activos/trial
    // const users = await db.getActiveUsers()
    
    console.log('‚úÖ [PREVENTIVE] Escaneo completado')
  } catch (error) {
    console.error('‚ùå [PREVENTIVE] Error en escaneo:', error)
  }
}

/**
 * Procesar email de soporte para detectar quejas
 */
export async function processIncomingSupportEmail(
  from: string,
  subject: string,
  body: string
): Promise<void> {
  console.log(`üì® [PREVENTIVE] Procesando email de: ${from}`)
  
  // Detectar palabras clave de queja
  const text = `${subject} ${body}`.toLowerCase()
  
  const hasComplaint = PREVENTIVE_CONFIG.complaintKeywords.some(keyword => 
    text.includes(keyword.toLowerCase())
  )
  
  if (hasComplaint && PREVENTIVE_CONFIG.autoRefundOnComplaint) {
    console.log(`üö® [PREVENTIVE] Queja detectada en email de ${from}`)
    
    // Buscar usuario
    const user = await db.getUserByEmail(from)
    
    if (user && user.subscriptionId) {
      // Ejecutar reembolso preventivo autom√°tico
      console.log(`üõ°Ô∏è [PREVENTIVE] Ejecutando reembolso preventivo para ${from}`)
      
      // Nota: Necesitar√≠as el orderId de FastSpring
      // await executePreventiveRefund(orderId, 'Queja de cliente detectada', from)
      
      // Enviar email al admin
      await sendEmail({
        to: PREVENTIVE_CONFIG.alertEmails[0],
        subject: `‚ö†Ô∏è Queja detectada - Acci√≥n requerida: ${from}`,
        html: `
          <h3>Queja detectada en email de soporte</h3>
          <p><strong>Cliente:</strong> ${from}</p>
          <p><strong>Asunto:</strong> ${subject}</p>
          <p><strong>Mensaje:</strong></p>
          <pre>${body}</pre>
          <p><strong>Acci√≥n recomendada:</strong> Contactar inmediatamente y ofrecer reembolso</p>
        `
      })
    }
  }
}

