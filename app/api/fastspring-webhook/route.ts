import { NextRequest, NextResponse } from 'next/server'
import { db } from '@/lib/database-postgres'
import { sendEmail } from '@/lib/email-service'
import { getEmailTranslation } from '@/lib/email-translations'
export const dynamic = 'force-dynamic'

// Tipos de eventos FastSpring
type FastSpringEvent = 
  | 'order.completed'
  | 'subscription.activated'
  | 'subscription.charge.completed'
  | 'subscription.charge.failed'
  | 'subscription.canceled'
  | 'subscription.deactivated'
  | 'subscription.payment.reminder'
  | 'return.created'
  | 'fulfillment.created'

interface FastSpringWebhookEvent {
  id: string
  type: FastSpringEvent
  live: boolean
  processed: boolean
  created: number
  data: any
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const events = body.events as FastSpringWebhookEvent[]

    console.log('üì® Webhook de FastSpring recibido:', events?.length || 0, 'eventos')

    // Verificar HMAC signature si est√° configurado
    const signature = request.headers.get('x-fastspring-signature')
    const webhookSecret = process.env.FASTSPRING_WEBHOOK_SECRET
    
    if (webhookSecret && signature) {
      // TODO: Implementar verificaci√≥n HMAC si lo configuras en FastSpring
      console.log('üîê Verificando firma del webhook...')
    }

    if (!events || !Array.isArray(events)) {
      console.error('‚ùå Formato de webhook inv√°lido')
      return NextResponse.json({ error: 'Formato inv√°lido' }, { status: 400 })
    }

    for (const event of events) {
      console.log(`üì¶ Procesando evento: ${event.type} (ID: ${event.id})`)

      try {
        switch (event.type) {
          case 'order.completed':
            await handleOrderCompleted(event.data)
            break

          case 'subscription.activated':
            await handleSubscriptionActivated(event.data)
            break

          case 'subscription.charge.completed':
            await handleSubscriptionChargeCompleted(event.data)
            break

          case 'subscription.charge.failed':
            await handleSubscriptionChargeFailed(event.data)
            break

          case 'subscription.canceled':
            await handleSubscriptionCanceled(event.data)
            break

          case 'subscription.deactivated':
            await handleSubscriptionDeactivated(event.data)
            break

          case 'return.created':
            await handleReturnCreated(event.data)
            break

          default:
            console.log(`‚ÑπÔ∏è Evento no manejado: ${event.type}`)
        }
      } catch (eventError) {
        console.error(`‚ùå Error procesando evento ${event.type}:`, eventError)
        // Continuar con el siguiente evento
      }
    }

    return NextResponse.json({ received: true })

  } catch (error: any) {
    console.error('‚ùå Error en webhook de FastSpring:', error)
    return NextResponse.json(
      { error: error.message },
      { status: 400 }
    )
  }
}

// ============================================
// HANDLERS DE EVENTOS
// ============================================

async function handleOrderCompleted(data: any) {
  console.log('‚úÖ Orden completada:', data.id || data.reference)
  
  const email = data.customer?.email
  const subscriptionId = data.items?.[0]?.subscription
  
  if (!email) {
    console.error('‚ùå No se encontr√≥ email en la orden')
    return
  }

  // Buscar usuario por email
  const user = await db.getUserByEmail(email)
  
  if (user) {
    console.log('üë§ Usuario encontrado:', user.id)
    
    // Actualizar subscription ID si existe
    if (subscriptionId && user.subscriptionId !== subscriptionId) {
      await db.updateUser(user.id, {
        subscriptionId: subscriptionId,
        subscriptionStatus: 'trial'
      })
      console.log('‚úÖ Subscription ID actualizado')
    }
  } else {
    console.log('‚ö†Ô∏è Usuario no encontrado, probablemente se crear√° en /api/fastspring-process-order')
  }
}

async function handleSubscriptionActivated(data: any) {
  console.log('‚úÖ Suscripci√≥n activada:', data.id)
  
  const user = await db.getUserBySubscriptionId(data.id)
  
  if (!user) {
    console.error('‚ùå Usuario no encontrado para subscription:', data.id)
    return
  }

  console.log('üë§ Usuario encontrado:', user.email)

  // Actualizar a activa (despu√©s del trial)
  const nextChargeDate = data.nextChargeDate ? new Date(data.nextChargeDate * 1000) : null
  
  await db.updateUser(user.id, {
    subscriptionStatus: 'active',
    accessUntil: nextChargeDate ? nextChargeDate.toISOString() : undefined
  })

  console.log('‚úÖ Usuario actualizado a activo')

  // Enviar email de activaci√≥n
  try {
    const lang = data.tags?.lang || 'es'
    const t = (key: any) => getEmailTranslation(lang, key)
    
    await sendEmail({
      to: user.email,
      subject: t('subscriptionActivatedSubject') || 'Suscripci√≥n activada - IQmind',
      html: `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Suscripci√≥n Activada</title>
        </head>
        <body style="font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px;">
          <div style="max-width: 600px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px;">
            <h2 style="color: #031C43;">‚úÖ Tu suscripci√≥n est√° activa</h2>
            <p>Hola ${user.userName},</p>
            <p>Tu per√≠odo de prueba ha finalizado y tu suscripci√≥n premium ha sido activada exitosamente.</p>
            <p><strong>Pr√≥ximo cargo:</strong> ${nextChargeDate ? nextChargeDate.toLocaleDateString('es-ES') : 'N/A'}</p>
            <p><strong>Monto:</strong> ‚Ç¨9.99/mes</p>
            <p>Puedes cancelar en cualquier momento desde tu cuenta.</p>
            <a href="${process.env.NEXT_PUBLIC_APP_URL}/${lang}/cuenta" style="display: inline-block; background: #218B8E; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin-top: 20px;">
              Acceder a mi cuenta
            </a>
          </div>
        </body>
        </html>
      `
    })
    console.log('üìß Email de activaci√≥n enviado')
  } catch (emailError) {
    console.error('‚ùå Error enviando email:', emailError)
  }
}

async function handleSubscriptionChargeCompleted(data: any) {
  console.log('üí≥ Cargo de suscripci√≥n completado:', data.id)
  
  const user = await db.getUserBySubscriptionId(data.subscription)
  
  if (!user) {
    console.error('‚ùå Usuario no encontrado para subscription:', data.subscription)
    return
  }

  console.log('üë§ Usuario encontrado:', user.email)

  // Extender acceso hasta el pr√≥ximo cargo
  const nextChargeDate = data.nextChargeDate ? new Date(data.nextChargeDate * 1000) : null
  
  await db.updateUser(user.id, {
    subscriptionStatus: 'active',
    accessUntil: nextChargeDate ? nextChargeDate.toISOString() : undefined
  })

  console.log('‚úÖ Acceso extendido')

  // Enviar email de confirmaci√≥n de pago mensual
  try {
    const amount = (data.amountInPayoutCurrency || data.total || 9.99).toFixed(2)
    const currency = data.currency || 'EUR'
    const lang = data.tags?.lang || 'es'
    
    await sendEmail({
      to: user.email,
      subject: 'Pago recibido - IQmind',
      html: `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Pago Recibido</title>
        </head>
        <body style="font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px;">
          <div style="max-width: 600px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px;">
            <h2 style="color: #031C43;">‚úÖ Pago recibido</h2>
            <p>Hola ${user.userName},</p>
            <p>Hemos recibido tu pago mensual de <strong>${amount} ${currency}</strong>.</p>
            <p>Tu suscripci√≥n contin√∫a activa.</p>
            <p><strong>Pr√≥ximo cargo:</strong> ${nextChargeDate ? nextChargeDate.toLocaleDateString('es-ES') : 'N/A'}</p>
            <p>Gracias por confiar en IQmind.</p>
            <a href="${process.env.NEXT_PUBLIC_APP_URL}/${lang}/cuenta" style="display: inline-block; background: #218B8E; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin-top: 20px;">
              Ver mi cuenta
            </a>
          </div>
        </body>
        </html>
      `
    })
    console.log('üìß Email de confirmaci√≥n de pago enviado')
  } catch (emailError) {
    console.error('‚ùå Error enviando email:', emailError)
  }
}

async function handleSubscriptionChargeFailed(data: any) {
  console.log('‚ùå Cargo de suscripci√≥n fallido:', data.id)
  
  const user = await db.getUserBySubscriptionId(data.subscription)
  
  if (!user) {
    console.error('‚ùå Usuario no encontrado para subscription:', data.subscription)
    return
  }

  console.log('üë§ Usuario encontrado:', user.email)

  // Enviar email de pago fallido
  try {
    const attempt = data.attemptCount || 1
    const lang = data.tags?.lang || 'es'
    
    await sendEmail({
      to: user.email,
      subject: '‚ö†Ô∏è Problema con tu pago - IQmind',
      html: `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Problema con el pago</title>
        </head>
        <body style="font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px;">
          <div style="max-width: 600px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px;">
            <h2 style="color: #c53030;">‚ö†Ô∏è No pudimos procesar tu pago</h2>
            <p>Hola ${user.userName},</p>
            <p>No hemos podido procesar tu pago mensual de ‚Ç¨9.99.</p>
            <p><strong>Intento:</strong> ${attempt}</p>
            <p>Por favor, actualiza tu m√©todo de pago para evitar la cancelaci√≥n de tu suscripci√≥n.</p>
            <a href="${process.env.NEXT_PUBLIC_APP_URL}/${lang}/cuenta" style="display: inline-block; background: #c53030; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin-top: 20px;">
              Actualizar m√©todo de pago
            </a>
          </div>
        </body>
        </html>
      `
    })
    console.log('üìß Email de pago fallido enviado')
  } catch (emailError) {
    console.error('‚ùå Error enviando email:', emailError)
  }
}

async function handleSubscriptionCanceled(data: any) {
  console.log('üö´ Suscripci√≥n cancelada:', data.id)
  
  const user = await db.getUserBySubscriptionId(data.id)
  
  if (!user) {
    console.error('‚ùå Usuario no encontrado para subscription:', data.id)
    return
  }

  console.log('üë§ Usuario encontrado:', user.email)

  // Actualizar estado a cancelado
  const endDate = data.endDate ? new Date(data.endDate * 1000) : new Date()
  
  await db.updateUser(user.id, {
    subscriptionStatus: 'cancelled',
    accessUntil: endDate.toISOString()
  })

  console.log('‚úÖ Usuario marcado como cancelado')

  // Enviar email de confirmaci√≥n de cancelaci√≥n
  try {
    const lang = data.tags?.lang || 'es'
    const accessUntil = endDate.toLocaleDateString('es-ES')
    
    await sendEmail({
      to: user.email,
      subject: 'Suscripci√≥n cancelada - IQmind',
      html: `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Suscripci√≥n Cancelada</title>
        </head>
        <body style="font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px;">
          <div style="max-width: 600px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px;">
            <h2 style="color: #031C43;">Tu suscripci√≥n ha sido cancelada</h2>
            <p>Hola ${user.userName},</p>
            <p>Tu suscripci√≥n a IQmind ha sido cancelada.</p>
            <p><strong>Acceso hasta:</strong> ${accessUntil}</p>
            <p>Podr√°s seguir accediendo a tu cuenta hasta esa fecha.</p>
            <p>Si cambias de opini√≥n, puedes reactivar tu suscripci√≥n en cualquier momento.</p>
            <p>Lamentamos verte partir. üò¢</p>
            <a href="${process.env.NEXT_PUBLIC_APP_URL}/${lang}/cuenta" style="display: inline-block; background: #218B8E; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin-top: 20px;">
              Ver mi cuenta
            </a>
          </div>
        </body>
        </html>
      `
    })
    console.log('üìß Email de cancelaci√≥n enviado')
  } catch (emailError) {
    console.error('‚ùå Error enviando email:', emailError)
  }
}

async function handleSubscriptionDeactivated(data: any) {
  console.log('‚ùå Suscripci√≥n desactivada:', data.id)
  
  const user = await db.getUserBySubscriptionId(data.id)
  
  if (!user) {
    console.error('‚ùå Usuario no encontrado para subscription:', data.id)
    return
  }

  console.log('üë§ Usuario encontrado:', user.email)

  // Marcar como expirado
  await db.updateUser(user.id, {
    subscriptionStatus: 'expired'
  })

  console.log('‚úÖ Usuario marcado como expirado')
}

async function handleReturnCreated(data: any) {
  console.log('üîÑ Reembolso creado:', data.id)
  
  // FastSpring gestiona los reembolsos autom√°ticamente
  // Aqu√≠ puedes agregar l√≥gica adicional si necesitas hacer algo especial
  
  const email = data.customer?.email
  if (email) {
    const user = await db.getUserByEmail(email)
    
    if (user) {
      console.log('üë§ Usuario encontrado:', user.email)
      
      // Marcar como cancelado si se hizo reembolso total
      if (data.refundType === 'full') {
        await db.updateUser(user.id, {
          subscriptionStatus: 'cancelled'
        })
        console.log('‚úÖ Usuario cancelado por reembolso total')
      }
      
      // Enviar email de reembolso
      try {
        const lang = 'es' // Podr√≠as obtenerlo de alg√∫n metadata
        const amount = (data.total || 0).toFixed(2)
        
        await sendEmail({
          to: user.email,
          subject: 'Reembolso procesado - IQmind',
          html: `
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="utf-8">
              <title>Reembolso Procesado</title>
            </head>
            <body style="font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px;">
              <div style="max-width: 600px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px;">
                <h2 style="color: #031C43;">Reembolso procesado</h2>
                <p>Hola ${user.userName},</p>
                <p>Tu reembolso de <strong>${amount} EUR</strong> ha sido procesado.</p>
                <p>El dinero ser√° devuelto a tu m√©todo de pago original en 5-10 d√≠as h√°biles.</p>
                <p>Gracias por haber probado IQmind.</p>
              </div>
            </body>
            </html>
          `
        })
        console.log('üìß Email de reembolso enviado')
      } catch (emailError) {
        console.error('‚ùå Error enviando email:', emailError)
      }
    }
  }
}

