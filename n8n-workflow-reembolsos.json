{
  "name": "ğŸ¤– Agente Reembolsos MindMetric",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "filters": {
          "from": "",
          "subject": "",
          "to": "support@mindmetric.io"
        },
        "format": "simple",
        "options": {}
      },
      "id": "node-gmail-trigger",
      "name": "ğŸ“§ Gmail: Recibir Solicitud",
      "type": "n8n-nodes-base.emailReadImap",
      "typeVersion": 2,
      "position": [240, 300],
      "credentials": {
        "imap": {
          "id": "1",
          "name": "Gmail Support"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "prompt_sistema",
              "value": "Eres un asistente de atenciÃ³n al cliente de MindMetric especializado en reembolsos.\n\nTu tarea es analizar correos de clientes y extraer informaciÃ³n clave.\n\n---\n\n## INFORMACIÃ“N A EXTRAER:\n\nDebes responder ÃšNICAMENTE con un JSON con esta estructura:\n\n{\n  \"idioma\": \"es | en | fr | de | it | pt | other\",\n  \"email_cliente\": \"email@ejemplo.com\",\n  \"email_pago\": \"email usado en el pago (si es diferente o se menciona)\",\n  \"motivo_solicitud\": \"DescripciÃ³n breve del motivo\",\n  \"tipo_solicitud\": \"REEMBOLSO_INICIAL | REEMBOLSO_SUSCRIPCION | CANCELACION | QUEJA | OTRO\",\n  \"emocion\": \"NEUTRAL | FRUSTRADO | ENOJADO | EDUCADO\",\n  \"cumple_politica\": true | false,\n  \"razon_cumplimiento\": \"ExplicaciÃ³n de por quÃ© cumple o no cumple\",\n  \"respuesta_sugerida\": \"Respuesta empÃ¡tica y profesional en EL MISMO IDIOMA del email\",\n  \"datos_pedido\": {\n    \"fecha_pago\": \"fecha mencionada del pago (formato: YYYY-MM-DD)\",\n    \"monto\": \"monto del pago mencionado\",\n    \"ultimos_4_digitos\": \"Ãºltimos 4 dÃ­gitos de tarjeta si se mencionan\",\n    \"transaction_id\": \"ID de transacciÃ³n si se menciona\",\n    \"nombre_titular\": \"nombre del titular de la tarjeta si se menciona\"\n  }\n}\n\nIMPORTANTE:\n- Si el cliente menciona \"paguÃ© con otro email\", extrÃ¡elo en email_pago\n- Si menciona \"mi email de pago es...\", extrÃ¡elo en email_pago\n- Busca CUALQUIER dato del pedido que mencione (fecha, monto, tarjeta, etc.)\n- Si no menciona datos_pedido, deja los campos vacÃ­os o null\n\n---\n\n## POLÃTICA DE REEMBOLSOS DE MINDMETRIC:\n\n### â›” NO REEMBOLSABLE:\n\n**1. PAGO INICIAL (1â‚¬):**\n- â›” NO es reembolsable bajo NINGUNA circunstancia\n- RazÃ³n: Contenido digital ya entregado (resultado del test)\n- SIEMPRE marca cumple_politica como FALSE si solicitan reembolso del pago inicial\n\n### âœ… REEMBOLSOS APROBADOS (SOLO SUSCRIPCIONES):\n\n**2. SUSCRIPCIÃ“N (9.99â‚¬/19.99â‚¬):**\nSolo reembolsable si:\n- âœ… Indisponibilidad > 24 horas consecutivas (documentada, NO mantenimiento)\n- âœ… Problemas tÃ©cnicos verificables (error impide acceso a funciones)\n- âœ… Errores de facturaciÃ³n (doble cargo, monto incorrecto, no autorizado)\n- âœ… Requisito legal (derecho de desistimiento, orden judicial)\n\n### âŒ REEMBOLSOS DENEGADOS:\n\n- â›” Pago inicial de 1â‚¬ (por cualquier motivo)\n- â›” Cambio de opiniÃ³n / \"Ya no lo necesito\"\n- â›” \"OlvidÃ© cancelar antes de renovaciÃ³n\"\n- â›” Tiempo de suscripciÃ³n no utilizado tras cancelaciÃ³n\n- â›” \"Es muy caro\" / \"No me gustÃ³\"\n- â›” Mantenimiento programado o breve (< 24 horas)\n- â›” Rebaja de planes o cambios\n- â›” InsatisfacciÃ³n con resultados del training\n\n### ğŸ”„ CANCELACIONES (Sin Reembolso):\n\nâœ… SIEMPRE PERMITIDAS:\n- \"Quiero cancelar mi suscripciÃ³n\"\n- \"Por favor cancelen mi plan\"\n- \"Dar de baja mi cuenta\"\n- \"No quiero que me cobren mÃ¡s\"\n\nACCIÃ“N:\n- Marca cumple_politica = true\n- tipo_solicitud = \"CANCELACION\"\n- Cancelar suscripciÃ³n en Stripe\n- NO generar reembolso\n- Email: ConfirmaciÃ³n con fecha de fin de acceso\n\n---\n\n## INSTRUCCIONES FINALES:\n\n1. **IDIOMA:** DETECTA el idioma del email y responde en ese mismo idioma\n   - EspaÃ±ol: \"idioma\": \"es\"\n   - InglÃ©s: \"idioma\": \"en\"\n   - FrancÃ©s: \"idioma\": \"fr\"\n   - AlemÃ¡n: \"idioma\": \"de\"\n   - Italiano: \"idioma\": \"it\"\n   - PortuguÃ©s: \"idioma\": \"pt\"\n   - Si no puedes detectar: \"idioma\": \"en\" (inglÃ©s por defecto)\n\n2. SIEMPRE responde con JSON vÃ¡lido\n3. SIEMPRE sÃ© empÃ¡tico y profesional\n4. IMPORTANTE: Pago inicial 1â‚¬ NUNCA es reembolsable (cumple_politica = false)\n5. Solo suscripciones pueden ser reembolsables (y solo en casos especÃ­ficos)\n6. Si el email NO es sobre reembolso/cancelaciÃ³n, usa tipo \"OTRO\"\n7. Si falta informaciÃ³n, marca cumple_politica como false\n8. La respuesta_sugerida DEBE estar en el MISMO IDIOMA que el email del cliente"
            }
          ]
        },
        "options": {}
      },
      "id": "node-prompt-sistema",
      "name": "ğŸ§  Prompt del Sistema",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [440, 300]
    },
    {
      "parameters": {
        "resource": "chat",
        "operation": "create",
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4"
        },
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "={{ $('ğŸ§  Prompt del Sistema').item.json.prompt_sistema }}"
            },
            {
              "role": "user",
              "content": "=EMAIL DEL CLIENTE:\nDe: {{ $json.from }}\nAsunto: {{ $json.subject }}\n\nContenido:\n{{ $json.text }}"
            }
          ]
        },
        "options": {
          "temperature": 0.3,
          "maxTokens": 1000
        }
      },
      "id": "node-openai-agent",
      "name": "ğŸ¤– OpenAI: Analizar Solicitud",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [640, 300],
      "credentials": {
        "openAiApi": {
          "id": "2",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parsear respuesta de OpenAI\nconst response = $input.item.json.message?.content || $input.item.json.choices[0]?.message?.content;\n\nlet analisisIA;\ntry {\n  // Extraer JSON de la respuesta (puede venir con markdown)\n  const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\n  analisisIA = JSON.parse(jsonMatch[0]);\n} catch (error) {\n  return {\n    error: true,\n    mensaje: \"No se pudo parsear la respuesta de OpenAI\",\n    respuesta_raw: response\n  };\n}\n\n// Combinar con datos del email original\nconst emailOriginal = $('ğŸ“§ Gmail: Recibir Solicitud').item.json;\n\nreturn {\n  ...analisisIA,\n  email_remitente: emailOriginal.from,\n  asunto_original: emailOriginal.subject,\n  fecha_recepcion: new Date().toISOString(),\n  email_completo: emailOriginal.text\n};"
      },
      "id": "node-parsear-ia",
      "name": "ğŸ“ Parsear Respuesta IA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [840, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.tipo_solicitud }}",
              "operation": "notEquals",
              "value2": "OTRO"
            }
          ]
        }
      },
      "id": "node-if-es-reembolso",
      "name": "ğŸ”€ Â¿Es Solicitud de Reembolso?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1040, 300]
    },
    {
      "parameters": {
        "jsCode": "// Obtener datos del anÃ¡lisis de IA\nconst analisisIA = $input.item.json;\n\n// Determinar quÃ© email usar para la bÃºsqueda\nlet emailBusqueda = analisisIA.email_cliente;\n\n// Si el cliente mencionÃ³ un email de pago diferente, usarlo\nif (analisisIA.email_pago && analisisIA.email_pago !== analisisIA.email_cliente) {\n  emailBusqueda = analisisIA.email_pago;\n  console.log(`Cliente escribiÃ³ desde ${analisisIA.email_cliente} pero mencionÃ³ email de pago: ${emailBusqueda}`);\n}\n\n// Construir query de bÃºsqueda en Stripe\nconst query = `email:'${emailBusqueda}'`;\n\nreturn {\n  email_busqueda: emailBusqueda,\n  query_stripe: query,\n  tiene_datos_adicionales: !!(analisisIA.datos_pedido?.fecha_pago || analisisIA.datos_pedido?.monto || analisisIA.datos_pedido?.ultimos_4_digitos),\n  ...analisisIA\n};"
      },
      "id": "node-preparar-busqueda",
      "name": "ğŸ”§ Preparar BÃºsqueda Cliente",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1240, 200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://api.stripe.com/v1/customers/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "stripeApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ $json.query_stripe }}"
            }
          ]
        },
        "options": {}
      },
      "id": "node-buscar-stripe",
      "name": "ğŸ” Stripe: Buscar Cliente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1440, 200],
      "credentials": {
        "stripeApi": {
          "id": "3",
          "name": "Stripe API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.data.length }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "node-if-cliente-existe",
      "name": "ğŸ”€ Â¿Cliente Existe en Stripe?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1640, 200]
    },
    {
      "parameters": {
        "jsCode": "// Obtener datos del anÃ¡lisis de IA\nconst analisisIA = $('ğŸ“ Parsear Respuesta IA').item.json;\n\n// Obtener datos del cliente de Stripe\nconst stripeData = $input.item.json;\nconst customer = stripeData.data[0];\n\nif (!customer) {\n  return {\n    cumple_politica: false,\n    razon: \"Cliente no encontrado en Stripe\",\n    ...analisisIA\n  };\n}\n\n// Obtener todos los charges del cliente\nconst charges = customer.charges?.data || [];\nconst subscriptions = customer.subscriptions?.data || [];\n\n// Timestamps\nconst ahora = Math.floor(Date.now() / 1000);\nconst hace30Dias = ahora - (30 * 24 * 60 * 60);\n\n// Buscar el pago inicial de 1â‚¬ (dos cargos de 0.50â‚¬ = 50 centavos cada uno)\nconst pagosIniciales = charges.filter(charge => \n  charge.amount === 50 && \n  charge.status === 'succeeded'\n);\n\n// Buscar suscripciÃ³n activa\nconst suscripcionActiva = subscriptions.find(sub => \n  sub.status === 'active' || sub.status === 'trialing'\n);\n\n// CASO 1: REEMBOLSO PAGO INICIAL (1â‚¬) - NO REEMBOLSABLE\nif (analisisIA.tipo_solicitud === \"REEMBOLSO_INICIAL\") {\n  // El pago inicial de 1â‚¬ NUNCA es reembolsable\n  return {\n    ...analisisIA,\n    cumple_politica: false,\n    razon: \"El pago inicial de 1â‚¬ NO es reembolsable - es contenido digital ya entregado (resultado del test)\",\n    customer_id: customer.id,\n    tipo: \"REEMBOLSO_INICIAL\",\n    accion_sugerida: \"Explicar polÃ­tica + ofrecer soporte tÃ©cnico si hubo problemas con el test\"\n  };\n}\n\n// CASO 2: REEMBOLSO SUSCRIPCIÃ“N\nif (analisisIA.tipo_solicitud === \"REEMBOLSO_SUSCRIPCION\") {\n  // Buscar Ãºltimo cargo de suscripciÃ³n (> 1â‚¬)\n  const ultimoCargo = charges\n    .filter(c => c.amount >= 999 && c.status === 'succeeded') // >= 9.99â‚¬\n    .sort((a, b) => b.created - a.created)[0];\n  \n  if (!ultimoCargo) {\n    return {\n      ...analisisIA,\n      cumple_politica: false,\n      razon: \"No se encontraron cargos de suscripciÃ³n\",\n      customer_id: customer.id\n    };\n  }\n  \n  // Motivos vÃ¡lidos para reembolso de suscripciÃ³n\n  const motivosValidos = [\n    \"indisponibilidad\",\n    \"problemas tÃ©cnicos\",\n    \"error de facturaciÃ³n\",\n    \"cargo duplicado\",\n    \"no funciona\",\n    \"caÃ­da\",\n    \"down\",\n    \"bug\"\n  ];\n  \n  const motivoValido = motivosValidos.some(motivo => \n    analisisIA.motivo_solicitud.toLowerCase().includes(motivo)\n  );\n  \n  // Verificar si fue reportado dentro de 30 dÃ­as\n  const dentroDeVentana = ultimoCargo.created > hace30Dias;\n  \n  if (motivoValido && dentroDeVentana) {\n    return {\n      ...analisisIA,\n      cumple_politica: true,\n      razon: `Motivo tÃ©cnico vÃ¡lido: ${analisisIA.motivo_solicitud}`,\n      customer_id: customer.id,\n      charge_ids: [ultimoCargo.id],\n      subscription_id: suscripcionActiva?.id,\n      monto_total: ultimoCargo.amount,\n      tipo: \"REEMBOLSO_SUSCRIPCION\"\n    };\n  } else {\n    return {\n      ...analisisIA,\n      cumple_politica: false,\n      razon: !motivoValido \n        ? \"Motivo no cumple con polÃ­tica de reembolsos\" \n        : \"Reporte fuera de ventana de 30 dÃ­as\",\n      customer_id: customer.id,\n      subscription_id: suscripcionActiva?.id, // Incluir para poder ofrecer cancelaciÃ³n\n      ofrecer_cancelacion: !!suscripcionActiva // Flag para saber si ofrecer cancelar\n    };\n  }\n}\n\n// CASO 3: SOLO CANCELACIÃ“N (sin reembolso) - SIEMPRE PERMITIDA\nif (analisisIA.tipo_solicitud === \"CANCELACION\") {\n  // Verificar si tiene suscripciÃ³n activa\n  if (!suscripcionActiva) {\n    return {\n      ...analisisIA,\n      cumple_politica: false,\n      razon: \"No tiene suscripciÃ³n activa para cancelar\",\n      customer_id: customer.id,\n      tipo: \"CANCELACION\"\n    };\n  }\n  \n  return {\n    ...analisisIA,\n    cumple_politica: true, // SIEMPRE true para cancelaciones\n    razon: \"Solicitud de cancelaciÃ³n - siempre permitida\",\n    customer_id: customer.id,\n    subscription_id: suscripcionActiva.id,\n    tipo: \"CANCELACION\",\n    solo_cancelar: true, // Flag importante: solo cancelar, NO reembolsar\n    accion: \"Cancelar suscripciÃ³n sin reembolso\"\n  };\n}\n\n// DEFAULT: NO CUMPLE\nreturn {\n  ...analisisIA,\n  cumple_politica: false,\n  razon: \"No cumple con criterios de reembolso\",\n  customer_id: customer.id\n};"
        },
        "id": "node-evaluar-politica",
        "name": "âš–ï¸ Evaluar PolÃ­tica de Reembolso",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [1840, 100]
      },
      {
        "parameters": {
          "conditions": {
            "boolean": [
              {
                "value1": "={{ $json.cumple_politica }}",
                "value2": true
              }
            ]
          }
        },
        "id": "node-if-cumple-politica",
        "name": "ğŸ”€ Â¿Cumple PolÃ­tica?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 1,
        "position": [2040, 100]
      },
      {
        "parameters": {
          "conditions": {
            "boolean": [
              {
                "value1": "={{ $json.solo_cancelar }}",
                "value2": true
              }
            ]
          }
        },
        "id": "node-if-solo-cancelar",
        "name": "ğŸ”€ Â¿Es Solo CancelaciÃ³n?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 1,
        "position": [2240, 0]
      },
      {
        "parameters": {
          "jsCode": "// Procesar reembolso de cada cargo\nconst data = $input.item.json;\nconst chargeIds = data.charge_ids || [];\n\n// Crear array de promesas de reembolso\nconst reembolsos = [];\n\nfor (const chargeId of chargeIds) {\n  reembolsos.push({\n    charge_id: chargeId,\n    customer_id: data.customer_id,\n    monto: data.tipo === \"REEMBOLSO_INICIAL\" ? 50 : data.monto_total,\n    email: data.email_cliente\n  });\n}\n\nreturn reembolsos.map(r => ({ json: r }));"
        },
        "id": "node-preparar-reembolsos",
        "name": "ğŸ’³ Preparar Reembolsos",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [2440, -100]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.stripe.com/v1/refunds",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "stripeApi",
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "charge",
                "value": "={{ $json.charge_id }}"
              },
              {
                "name": "amount",
                "value": "={{ $json.monto }}"
              },
              {
                "name": "reason",
                "value": "requested_by_customer"
              },
              {
                "name": "metadata[email]",
                "value": "={{ $json.email }}"
              },
              {
                "name": "metadata[procesado_por]",
                "value": "n8n-agente-ia"
              }
            ]
          },
          "options": {}
        },
        "id": "node-crear-reembolso",
        "name": "ğŸ’° Stripe: Crear Reembolso",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4,
        "position": [2640, -100],
        "credentials": {
          "stripeApi": {
            "id": "3",
            "name": "Stripe API"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "string": [
              {
                "value1": "={{ $('âš–ï¸ Evaluar PolÃ­tica de Reembolso').item.json.subscription_id }}",
                "operation": "isNotEmpty"
              }
            ]
          }
        },
        "id": "node-if-tiene-suscripcion",
        "name": "ğŸ”€ Â¿Tiene SuscripciÃ³n Activa?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 1,
        "position": [2840, -100]
      },
      {
        "parameters": {
          "method": "DELETE",
          "url": "=https://api.stripe.com/v1/subscriptions/{{ $('âš–ï¸ Evaluar PolÃ­tica de Reembolso').item.json.subscription_id }}",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "stripeApi",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "invoice_now",
                "value": "false"
              }
            ]
          },
          "options": {}
        },
        "id": "node-cancelar-suscripcion",
        "name": "ğŸš« Stripe: Cancelar SuscripciÃ³n",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4,
        "position": [3040, -200],
        "credentials": {
          "stripeApi": {
            "id": "3",
            "name": "Stripe API"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Obtener datos\nconst analisisIA = $('ğŸ“ Parsear Respuesta IA').item.json;\nconst evaluacion = $('âš–ï¸ Evaluar PolÃ­tica de Reembolso').item.json;\nconst idioma = analisisIA.idioma || 'en';\n\n// Plantillas por idioma\nconst plantillas = {\n  es: {\n    subject: 'Reembolso Procesado - MindMetric',\n    title: 'âœ… Reembolso Procesado',\n    greeting: 'Hola,',\n    success: 'âœ“ Tu reembolso ha sido procesado exitosamente',\n    details_title: 'Detalles del reembolso:',\n    amount: 'Monto:',\n    method: 'MÃ©todo:',\n    time: 'Tiempo estimado:',\n    time_value: '3-5 dÃ­as hÃ¡biles',\n    payment_method: 'Pago inicial',\n    subscription_method: 'SuscripciÃ³n',\n    info: 'El reembolso se procesarÃ¡ al mismo mÃ©todo de pago que utilizaste originalmente.',\n    questions: 'Si tienes alguna pregunta, no dudes en contactarnos.',\n    thanks: 'Gracias por tu comprensiÃ³n.',\n    signature: 'Atentamente,<br><strong>Equipo de MindMetric</strong>',\n    footer: 'Este es un email automÃ¡tico generado por nuestro sistema de IA.'\n  },\n  en: {\n    subject: 'Refund Processed - MindMetric',\n    title: 'âœ… Refund Processed',\n    greeting: 'Hello,',\n    success: 'âœ“ Your refund has been processed successfully',\n    details_title: 'Refund details:',\n    amount: 'Amount:',\n    method: 'Method:',\n    time: 'Estimated time:',\n    time_value: '3-5 business days',\n    payment_method: 'Initial payment',\n    subscription_method: 'Subscription',\n    info: 'The refund will be processed to the same payment method you originally used.',\n    questions: 'If you have any questions, please don\\'t hesitate to contact us.',\n    thanks: 'Thank you for your understanding.',\n    signature: 'Best regards,<br><strong>MindMetric Team</strong>',\n    footer: 'This is an automated email generated by our AI system.'\n  }\n};\n\nconst t = plantillas[idioma] || plantillas.en;\n\nconst monto = evaluacion.monto_total / 100;\nconst metodo = evaluacion.tipo === 'REEMBOLSO_INICIAL' ? t.payment_method : t.subscription_method;\n\nconst email_body = `<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #113240 0%, #052547 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n    .content { background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; }\n    .success-box { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 20px 0; border-radius: 5px; }\n    .footer { background: #f8f9fa; padding: 20px; text-align: center; font-size: 12px; color: #666; border-radius: 0 0 10px 10px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>${t.title}</h1>\n    </div>\n    <div class=\"content\">\n      <p>${t.greeting}</p>\n      \n      <div class=\"success-box\">\n        <p><strong>${t.success}</strong></p>\n      </div>\n      \n      <p>${analisisIA.respuesta_sugerida}</p>\n      \n      <p><strong>${t.details_title}</strong></p>\n      <ul>\n        <li><strong>${t.amount}</strong> ${monto}â‚¬</li>\n        <li><strong>${t.method}</strong> ${metodo}</li>\n        <li><strong>${t.time}</strong> ${t.time_value}</li>\n      </ul>\n      \n      <p>${t.info}</p>\n      \n      <p>${t.questions}</p>\n      \n      <p>${t.thanks}</p>\n      \n      <p>${t.signature}</p>\n    </div>\n    <div class=\"footer\">\n      <p>MindMetric | <a href=\"https://mindmetric.io\">mindmetric.io</a></p>\n      <p>${t.footer}</p>\n    </div>\n  </div>\n</body>\n</html>`;\n\nreturn {\n  ...analisisIA,\n  ...evaluacion,\n  email_subject: t.subject,\n  email_body: email_body\n};"
        },
        "id": "node-preparar-email-reembolso",
        "name": "ğŸŒ Preparar Email Reembolso",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [3240, -100]
      },
      {
        "parameters": {
          "jsCode": "// Obtener datos\nconst analisisIA = $('ğŸ“ Parsear Respuesta IA').item.json;\nconst idioma = analisisIA.idioma || 'en';\n\n// Plantillas por idioma\nconst plantillas = {\n  es: {\n    subject: 'âœ… SuscripciÃ³n Cancelada - MindMetric',\n    title: 'âœ… SuscripciÃ³n Cancelada',\n    greeting: 'Hola,',\n    success: 'âœ“ Tu suscripciÃ³n ha sido cancelada exitosamente',\n    info_title: 'InformaciÃ³n importante:',\n    info_1: 'No habrÃ¡ mÃ¡s cargos a tu tarjeta',\n    info_2: 'Puedes seguir usando el servicio hasta el final del perÃ­odo actual',\n    info_3: 'Tu cuenta permanecerÃ¡ activa (sin acceso premium)',\n    reactivate: 'Si en el futuro deseas reactivar tu suscripciÃ³n, estaremos encantados de ayudarte.',\n    goodbye: 'Â¡Gracias por haber sido parte de MindMetric!',\n    signature: 'Atentamente,<br><strong>Equipo de MindMetric</strong>',\n    footer: 'Este es un email automÃ¡tico generado por nuestro sistema de IA.'\n  },\n  en: {\n    subject: 'âœ… Subscription Cancelled - MindMetric',\n    title: 'âœ… Subscription Cancelled',\n    greeting: 'Hello,',\n    success: 'âœ“ Your subscription has been cancelled successfully',\n    info_title: 'Important information:',\n    info_1: 'There will be no more charges to your card',\n    info_2: 'You can continue using the service until the end of your current period',\n    info_3: 'Your account will remain active (without premium access)',\n    reactivate: 'If you wish to reactivate your subscription in the future, we\\'ll be happy to help.',\n    goodbye: 'Thank you for being part of MindMetric!',\n    signature: 'Best regards,<br><strong>MindMetric Team</strong>',\n    footer: 'This is an automated email generated by our AI system.'\n  }\n};\n\nconst t = plantillas[idioma] || plantillas.en;\n\nconst email_body = `<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #113240 0%, #052547 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n    .content { background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; }\n    .success-box { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 20px 0; border-radius: 5px; }\n    .info-box { background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin: 20px 0; border-radius: 5px; }\n    .footer { background: #f8f9fa; padding: 20px; text-align: center; font-size: 12px; color: #666; border-radius: 0 0 10px 10px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>${t.title}</h1>\n    </div>\n    <div class=\"content\">\n      <p>${t.greeting}</p>\n      \n      <div class=\"success-box\">\n        <p><strong>${t.success}</strong></p>\n      </div>\n      \n      <p>${analisisIA.respuesta_sugerida}</p>\n      \n      <div class=\"info-box\">\n        <p><strong>${t.info_title}</strong></p>\n        <ul style=\"margin: 10px 0; padding-left: 20px;\">\n          <li>${t.info_1}</li>\n          <li>${t.info_2}</li>\n          <li>${t.info_3}</li>\n        </ul>\n      </div>\n      \n      <p>${t.reactivate}</p>\n      \n      <p>${t.goodbye}</p>\n      \n      <p>${t.signature}</p>\n    </div>\n    <div class=\"footer\">\n      <p>MindMetric | <a href=\"https://mindmetric.io\">mindmetric.io</a></p>\n      <p>${t.footer}</p>\n    </div>\n  </div>\n</body>\n</html>`;\n\nreturn {\n  ...analisisIA,\n  email_subject: t.subject,\n  email_body: email_body\n};"
        },
        "id": "node-preparar-email-cancelacion",
        "name": "ğŸŒ Preparar Email CancelaciÃ³n",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [3240, 100]
      },
      {
        "parameters": {
          "fromEmail": "support@mindmetric.io",
          "toEmail": "={{ $('ğŸ“ Parsear Respuesta IA').item.json.email_cliente }}",
          "subject": "={{ $json.email_subject }}",
          "emailType": "html",
          "message": "={{ $json.email_body }}",
          "options": {}
        },
        "id": "node-email-reembolso-aprobado",
        "name": "ğŸ“¤ Email: Reembolso Aprobado",
        "type": "n8n-nodes-base.emailSend",
        "typeVersion": 2,
        "position": [3440, -100],
        "credentials": {
          "smtp": {
            "id": "4",
            "name": "SendGrid SMTP"
          }
        }
      },
      {
        "parameters": {
          "fromEmail": "support@mindmetric.io",
          "toEmail": "={{ $('ğŸ“ Parsear Respuesta IA').item.json.email_cliente }}",
          "subject": "={{ $json.email_subject }}",
          "emailType": "html",
          "message": "={{ $json.email_body }}",
          "options": {}
        },
        "id": "node-email-cancelacion",
        "name": "ğŸ“¤ Email: CancelaciÃ³n Confirmada",
        "type": "n8n-nodes-base.emailSend",
        "typeVersion": 2,
        "position": [3440, 100],
        "credentials": {
          "smtp": {
            "id": "4",
            "name": "SendGrid SMTP"
          }
        }
      },
      {
        "parameters": {
          "fromEmail": "support@mindmetric.io",
          "toEmail": "={{ $('ğŸ“ Parsear Respuesta IA').item.json.email_cliente }}",
          "subject": "=Re: {{ $('ğŸ“§ Gmail: Recibir Solicitud').item.json.subject }}",
          "emailType": "html",
          "message": "=<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #113240 0%, #052547 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n    .content { background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; }\n    .info-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px; }\n    .footer { background: #f8f9fa; padding: 20px; text-align: center; font-size: 12px; color: #666; border-radius: 0 0 10px 10px; }\n    .button { display: inline-block; background: #07C59A; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>ğŸ“‹ Sobre tu Solicitud</h1>\n    </div>\n    <div class=\"content\">\n      <p>Hola,</p>\n      \n      <p>{{ $('ğŸ“ Parsear Respuesta IA').item.json.respuesta_sugerida }}</p>\n      \n      <div class=\"info-box\">\n        <p><strong>RazÃ³n:</strong> {{ $('âš–ï¸ Evaluar PolÃ­tica de Reembolso').item.json.razon }}</p>\n      </div>\n      \n      <p><strong>Nuestra polÃ­tica de reembolsos establece que:</strong></p>\n      <ul>\n        <li>Pago inicial (1â‚¬): Reembolsable dentro de 30 dÃ­as (primera vez)</li>\n        <li>Suscripciones: Solo por problemas tÃ©cnicos documentados o errores de facturaciÃ³n</li>\n        <li>Cambio de opiniÃ³n o no cancelar antes de renovaciÃ³n: No reembolsable</li>\n      </ul>\n      \n      {{ $('âš–ï¸ Evaluar PolÃ­tica de Reembolso').item.json.solo_cancelar ? '<p><strong>âœ… Hemos cancelado tu suscripciÃ³n</strong> para evitar futuros cargos. Puedes seguir usando el servicio hasta el final del perÃ­odo actual.</p>' : '' }}\n      \n      <p>Si crees que hay un error o tienes informaciÃ³n adicional, por favor responde a este correo.</p>\n      \n      <a href=\"https://mindmetric.io/es/reembolso\" class=\"button\" style=\"color: white;\">Ver PolÃ­tica Completa</a>\n      \n      <p>Gracias por tu comprensiÃ³n.</p>\n      \n      <p>Atentamente,<br><strong>Equipo de MindMetric</strong></p>\n    </div>\n    <div class=\"footer\">\n      <p>MindMetric | <a href=\"https://mindmetric.io\">mindmetric.io</a></p>\n      <p>Este es un email automÃ¡tico generado por nuestro sistema de IA.</p>\n    </div>\n  </div>\n</body>\n</html>",
          "options": {}
        },
        "id": "node-email-reembolso-denegado",
        "name": "ğŸ“¤ Email: Reembolso Denegado",
        "type": "n8n-nodes-base.emailSend",
        "typeVersion": 2,
        "position": [3240, 300],
        "credentials": {
          "smtp": {
            "id": "4",
            "name": "SendGrid SMTP"
          }
        }
      },
      {
        "parameters": {
          "fromEmail": "support@mindmetric.io",
          "toEmail": "={{ $('ğŸ“§ Gmail: Recibir Solicitud').item.json.from }}",
          "subject": "=Re: {{ $('ğŸ“§ Gmail: Recibir Solicitud').item.json.subject }}",
          "emailType": "html",
          "message": "=<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #113240 0%, #052547 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n    .content { background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; }\n    .warning-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px; }\n    .info-box { background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin: 20px 0; border-radius: 5px; }\n    .footer { background: #f8f9fa; padding: 20px; text-align: center; font-size: 12px; color: #666; border-radius: 0 0 10px 10px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>ğŸ” InformaciÃ³n Adicional Requerida</h1>\n    </div>\n    <div class=\"content\">\n      <p>Hola,</p>\n      \n      <div class=\"warning-box\">\n        <p><strong>âš ï¸ No encontramos tu cuenta con el email: {{ $('ğŸ”§ Preparar BÃºsqueda Cliente').item.json.email_busqueda }}</strong></p>\n      </div>\n      \n      <p>Para procesar tu solicitud, necesitamos verificar algunos datos de tu pedido.</p>\n      \n      <div class=\"info-box\">\n        <p><strong>ğŸ“‹ Por favor, responde a este correo proporcionando:</strong></p>\n        <ol style=\"margin: 10px 0; padding-left: 20px;\">\n          <li><strong>Email usado en el pago</strong> (si es diferente a {{ $('ğŸ“§ Gmail: Recibir Solicitud').item.json.from }})</li>\n          <li><strong>Fecha aproximada del pago</strong> (dÃ­a/mes/aÃ±o)</li>\n          <li><strong>Monto del pago</strong> (1â‚¬, 9.99â‚¬ o 19.99â‚¬)</li>\n          <li><strong>Ãšltimos 4 dÃ­gitos de la tarjeta</strong> usada</li>\n          <li><strong>Nombre del titular</strong> de la tarjeta (opcional)</li>\n        </ol>\n      </div>\n      \n      <p><strong>ğŸ’¡ TambiÃ©n puedes adjuntar:</strong></p>\n      <ul>\n        <li>Captura del recibo de Stripe</li>\n        <li>Email de confirmaciÃ³n de pago</li>\n        <li>Extracto bancario (ocultando datos sensibles)</li>\n      </ul>\n      \n      <p>Con esta informaciÃ³n podremos localizar tu pedido y procesar tu solicitud rÃ¡pidamente.</p>\n      \n      <p><strong>Nota:</strong> Si escribiste desde un email diferente al de tu compra, es normal que no te encontremos. Simplemente proporciona el email correcto y te ayudaremos.</p>\n      \n      <p>Atentamente,<br><strong>Equipo de MindMetric</strong></p>\n    </div>\n    <div class=\"footer\">\n      <p>MindMetric | <a href=\"https://mindmetric.io\">mindmetric.io</a></p>\n      <p>support@mindmetric.io</p>\n      <p style=\"margin-top: 10px; font-size: 11px; color: #999;\">Responde a este correo con la informaciÃ³n solicitada</p>\n    </div>\n  </div>\n</body>\n</html>",
          "options": {}
        },
        "id": "node-email-no-encontrado",
        "name": "ğŸ“¤ Email: Cliente No Encontrado",
        "type": "n8n-nodes-base.emailSend",
        "typeVersion": 2,
        "position": [1840, 300],
        "credentials": {
          "smtp": {
            "id": "4",
            "name": "SendGrid SMTP"
          }
        }
      },
      {
        "parameters": {
          "fromEmail": "support@mindmetric.io",
          "toEmail": "={{ $('ğŸ“§ Gmail: Recibir Solicitud').item.json.from }}",
          "subject": "=Re: {{ $('ğŸ“§ Gmail: Recibir Solicitud').item.json.subject }}",
          "emailType": "html",
          "message": "=<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #113240 0%, #052547 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n    .content { background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; }\n    .footer { background: #f8f9fa; padding: 20px; text-align: center; font-size: 12px; color: #666; border-radius: 0 0 10px 10px; }\n    .button { display: inline-block; background: #07C59A; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>ğŸ‘‹ Gracias por Contactarnos</h1>\n    </div>\n    <div class=\"content\">\n      <p>Hola,</p>\n      \n      <p>{{ $('ğŸ“ Parsear Respuesta IA').item.json.respuesta_sugerida }}</p>\n      \n      <p>Si tu consulta es sobre reembolsos o cancelaciones, por favor especifÃ­calo claramente en tu respuesta.</p>\n      \n      <p><strong>Para reembolsos, incluye:</strong></p>\n      <ul>\n        <li>Email usado en el pago</li>\n        <li>Fecha del pago</li>\n        <li>Motivo del reembolso</li>\n      </ul>\n      \n      <a href=\"https://mindmetric.io/es/contacto\" class=\"button\" style=\"color: white;\">Formulario de Contacto</a>\n      \n      <p>Atentamente,<br><strong>Equipo de MindMetric</strong></p>\n    </div>\n    <div class=\"footer\">\n      <p>MindMetric | <a href=\"https://mindmetric.io\">mindmetric.io</a></p>\n      <p>support@mindmetric.io</p>\n    </div>\n  </div>\n</body>\n</html>",
          "options": {}
        },
        "id": "node-email-generico",
        "name": "ğŸ“¤ Email: Respuesta GenÃ©rica",
        "type": "n8n-nodes-base.emailSend",
        "typeVersion": 2,
        "position": [1240, 400],
        "credentials": {
          "smtp": {
            "id": "4",
            "name": "SendGrid SMTP"
          }
        }
      }
    ],
    "connections": {
      "ğŸ“§ Gmail: Recibir Solicitud": {
        "main": [
          [
            {
              "node": "ğŸ§  Prompt del Sistema",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ§  Prompt del Sistema": {
        "main": [
          [
            {
              "node": "ğŸ¤– OpenAI: Analizar Solicitud",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ¤– OpenAI: Analizar Solicitud": {
        "main": [
          [
            {
              "node": "ğŸ“ Parsear Respuesta IA",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ“ Parsear Respuesta IA": {
        "main": [
          [
            {
              "node": "ğŸ”€ Â¿Es Solicitud de Reembolso?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ”€ Â¿Es Solicitud de Reembolso?": {
        "main": [
          [
            {
              "node": "ğŸ”§ Preparar BÃºsqueda Cliente",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "ğŸ“¤ Email: Respuesta GenÃ©rica",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ”§ Preparar BÃºsqueda Cliente": {
        "main": [
          [
            {
              "node": "ğŸ” Stripe: Buscar Cliente",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ” Stripe: Buscar Cliente": {
        "main": [
          [
            {
              "node": "ğŸ”€ Â¿Cliente Existe en Stripe?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ”€ Â¿Cliente Existe en Stripe?": {
        "main": [
          [
            {
              "node": "âš–ï¸ Evaluar PolÃ­tica de Reembolso",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "ğŸ“¤ Email: Cliente No Encontrado",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "âš–ï¸ Evaluar PolÃ­tica de Reembolso": {
        "main": [
          [
            {
              "node": "ğŸ”€ Â¿Cumple PolÃ­tica?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ”€ Â¿Cumple PolÃ­tica?": {
        "main": [
          [
            {
              "node": "ğŸ”€ Â¿Es Solo CancelaciÃ³n?",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "ğŸ“¤ Email: Reembolso Denegado",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ”€ Â¿Es Solo CancelaciÃ³n?": {
        "main": [
          [
            {
              "node": "ğŸš« Stripe: Cancelar SuscripciÃ³n",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "ğŸ’³ Preparar Reembolsos",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ’³ Preparar Reembolsos": {
        "main": [
          [
            {
              "node": "ğŸ’° Stripe: Crear Reembolso",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ’° Stripe: Crear Reembolso": {
        "main": [
          [
            {
              "node": "ğŸŒ Preparar Email Reembolso",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸŒ Preparar Email Reembolso": {
        "main": [
          [
            {
              "node": "ğŸ“¤ Email: Reembolso Aprobado",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ”€ Â¿Tiene SuscripciÃ³n Activa?": {
        "main": [
          [
            {
              "node": "ğŸ“¤ Email: Reembolso Aprobado",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "ğŸ“¤ Email: Reembolso Aprobado",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸš« Stripe: Cancelar SuscripciÃ³n": {
        "main": [
          [
            {
              "node": "ğŸŒ Preparar Email CancelaciÃ³n",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸŒ Preparar Email CancelaciÃ³n": {
        "main": [
          [
            {
              "node": "ğŸ“¤ Email: CancelaciÃ³n Confirmada",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ“¤ Email: CancelaciÃ³n Confirmada": {
        "main": []
      },
      "ğŸ“¤ Email: Reembolso Aprobado": {
        "main": []
      }
    },
    "active": true,
    "settings": {
      "executionOrder": "v1"
    },
    "versionId": "1",
    "id": "mindmetric-refunds-agent",
    "meta": {
      "instanceId": "mindmetric-production"
    },
    "tags": []
  }

