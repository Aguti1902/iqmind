{
  "name": "ğŸ¤– Agente Reembolsos MindMetric",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "filters": {
          "from": "",
          "subject": "",
          "to": "refunds@mindmetric.io"
        },
        "format": "simple",
        "options": {}
      },
      "id": "node-gmail-trigger",
      "name": "ğŸ“§ Gmail: Recibir Solicitud",
      "type": "n8n-nodes-base.emailReadImap",
      "typeVersion": 2,
      "position": [240, 300],
      "credentials": {
        "imap": {
          "id": "1",
          "name": "Gmail Refunds"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "prompt_sistema",
              "value": "Eres un asistente de atenciÃ³n al cliente de MindMetric especializado en reembolsos.\n\nTu tarea es analizar correos de clientes y extraer informaciÃ³n clave.\n\n---\n\n## INFORMACIÃ“N A EXTRAER:\n\nDebes responder ÃšNICAMENTE con un JSON con esta estructura:\n\n{\n  \"email_cliente\": \"email@ejemplo.com\",\n  \"motivo_solicitud\": \"DescripciÃ³n breve del motivo\",\n  \"tipo_solicitud\": \"REEMBOLSO_INICIAL | REEMBOLSO_SUSCRIPCION | CANCELACION | QUEJA | OTRO\",\n  \"emocion\": \"NEUTRAL | FRUSTRADO | ENOJADO | EDUCADO\",\n  \"cumple_politica\": true | false,\n  \"razon_cumplimiento\": \"ExplicaciÃ³n de por quÃ© cumple o no cumple\",\n  \"respuesta_sugerida\": \"Respuesta empÃ¡tica y profesional en espaÃ±ol\"\n}\n\n---\n\n## POLÃTICA DE REEMBOLSOS DE MINDMETRIC:\n\n### â›” NO REEMBOLSABLE:\n\n**1. PAGO INICIAL (1â‚¬):**\n- â›” NO es reembolsable bajo NINGUNA circunstancia\n- RazÃ³n: Contenido digital ya entregado (resultado del test)\n- SIEMPRE marca cumple_politica como FALSE si solicitan reembolso del pago inicial\n\n### âœ… REEMBOLSOS APROBADOS (SOLO SUSCRIPCIONES):\n\n**2. SUSCRIPCIÃ“N (9.99â‚¬/19.99â‚¬):**\nSolo reembolsable si:\n- âœ… Indisponibilidad > 24 horas consecutivas (documentada, NO mantenimiento)\n- âœ… Problemas tÃ©cnicos verificables (error impide acceso a funciones)\n- âœ… Errores de facturaciÃ³n (doble cargo, monto incorrecto, no autorizado)\n- âœ… Requisito legal (derecho de desistimiento, orden judicial)\n\n### âŒ REEMBOLSOS DENEGADOS:\n\n- â›” Pago inicial de 1â‚¬ (por cualquier motivo)\n- â›” Cambio de opiniÃ³n / \"Ya no lo necesito\"\n- â›” \"OlvidÃ© cancelar antes de renovaciÃ³n\"\n- â›” Tiempo de suscripciÃ³n no utilizado tras cancelaciÃ³n\n- â›” \"Es muy caro\" / \"No me gustÃ³\"\n- â›” Mantenimiento programado o breve (< 24 horas)\n- â›” Rebaja de planes o cambios\n- â›” InsatisfacciÃ³n con resultados del training\n\n---\n\n## INSTRUCCIONES FINALES:\n\n1. SIEMPRE responde con JSON vÃ¡lido\n2. SIEMPRE sÃ© empÃ¡tico y profesional\n3. IMPORTANTE: Pago inicial 1â‚¬ NUNCA es reembolsable (cumple_politica = false)\n4. Solo suscripciones pueden ser reembolsables (y solo en casos especÃ­ficos)\n5. Si el email NO es sobre reembolso/cancelaciÃ³n, usa tipo \"OTRO\"\n6. Si falta informaciÃ³n, marca cumple_politica como false\n7. La respuesta_sugerida debe ser en el idioma del email recibido"
            }
          ]
        },
        "options": {}
      },
      "id": "node-prompt-sistema",
      "name": "ğŸ§  Prompt del Sistema",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [440, 300]
    },
    {
      "parameters": {
        "resource": "chat",
        "operation": "create",
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4"
        },
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "={{ $('ğŸ§  Prompt del Sistema').item.json.prompt_sistema }}"
            },
            {
              "role": "user",
              "content": "=EMAIL DEL CLIENTE:\nDe: {{ $json.from }}\nAsunto: {{ $json.subject }}\n\nContenido:\n{{ $json.text }}"
            }
          ]
        },
        "options": {
          "temperature": 0.3,
          "maxTokens": 1000
        }
      },
      "id": "node-openai-agent",
      "name": "ğŸ¤– OpenAI: Analizar Solicitud",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [640, 300],
      "credentials": {
        "openAiApi": {
          "id": "2",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parsear respuesta de OpenAI\nconst response = $input.item.json.message?.content || $input.item.json.choices[0]?.message?.content;\n\nlet analisisIA;\ntry {\n  // Extraer JSON de la respuesta (puede venir con markdown)\n  const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\n  analisisIA = JSON.parse(jsonMatch[0]);\n} catch (error) {\n  return {\n    error: true,\n    mensaje: \"No se pudo parsear la respuesta de OpenAI\",\n    respuesta_raw: response\n  };\n}\n\n// Combinar con datos del email original\nconst emailOriginal = $('ğŸ“§ Gmail: Recibir Solicitud').item.json;\n\nreturn {\n  ...analisisIA,\n  email_remitente: emailOriginal.from,\n  asunto_original: emailOriginal.subject,\n  fecha_recepcion: new Date().toISOString(),\n  email_completo: emailOriginal.text\n};"
      },
      "id": "node-parsear-ia",
      "name": "ğŸ“ Parsear Respuesta IA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [840, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.tipo_solicitud }}",
              "operation": "notEquals",
              "value2": "OTRO"
            }
          ]
        }
      },
      "id": "node-if-es-reembolso",
      "name": "ğŸ”€ Â¿Es Solicitud de Reembolso?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1040, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://api.stripe.com/v1/customers/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "stripeApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "=email:'{{ $json.email_cliente }}'"
            }
          ]
        },
        "options": {}
      },
      "id": "node-buscar-stripe",
      "name": "ğŸ” Stripe: Buscar Cliente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1240, 200],
      "credentials": {
        "stripeApi": {
          "id": "3",
          "name": "Stripe API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.data.length }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "node-if-cliente-existe",
      "name": "ğŸ”€ Â¿Cliente Existe en Stripe?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1440, 200]
    },
    {
      "parameters": {
        "jsCode": "// Obtener datos del anÃ¡lisis de IA\nconst analisisIA = $('ğŸ“ Parsear Respuesta IA').item.json;\n\n// Obtener datos del cliente de Stripe\nconst stripeData = $input.item.json;\nconst customer = stripeData.data[0];\n\nif (!customer) {\n  return {\n    cumple_politica: false,\n    razon: \"Cliente no encontrado en Stripe\",\n    ...analisisIA\n  };\n}\n\n// Obtener todos los charges del cliente\nconst charges = customer.charges?.data || [];\nconst subscriptions = customer.subscriptions?.data || [];\n\n// Timestamps\nconst ahora = Math.floor(Date.now() / 1000);\nconst hace30Dias = ahora - (30 * 24 * 60 * 60);\n\n// Buscar el pago inicial de 1â‚¬ (dos cargos de 0.50â‚¬ = 50 centavos cada uno)\nconst pagosIniciales = charges.filter(charge => \n  charge.amount === 50 && \n  charge.status === 'succeeded'\n);\n\n// Buscar suscripciÃ³n activa\nconst suscripcionActiva = subscriptions.find(sub => \n  sub.status === 'active' || sub.status === 'trialing'\n);\n\n// CASO 1: REEMBOLSO PAGO INICIAL (1â‚¬) - NO REEMBOLSABLE\nif (analisisIA.tipo_solicitud === \"REEMBOLSO_INICIAL\") {\n  // El pago inicial de 1â‚¬ NUNCA es reembolsable\n  return {\n    ...analisisIA,\n    cumple_politica: false,\n    razon: \"El pago inicial de 1â‚¬ NO es reembolsable - es contenido digital ya entregado (resultado del test)\",\n    customer_id: customer.id,\n    tipo: \"REEMBOLSO_INICIAL\",\n    accion_sugerida: \"Explicar polÃ­tica + ofrecer soporte tÃ©cnico si hubo problemas con el test\"\n  };\n}\n\n// CASO 2: REEMBOLSO SUSCRIPCIÃ“N\nif (analisisIA.tipo_solicitud === \"REEMBOLSO_SUSCRIPCION\") {\n  // Buscar Ãºltimo cargo de suscripciÃ³n (> 1â‚¬)\n  const ultimoCargo = charges\n    .filter(c => c.amount >= 999 && c.status === 'succeeded') // >= 9.99â‚¬\n    .sort((a, b) => b.created - a.created)[0];\n  \n  if (!ultimoCargo) {\n    return {\n      ...analisisIA,\n      cumple_politica: false,\n      razon: \"No se encontraron cargos de suscripciÃ³n\",\n      customer_id: customer.id\n    };\n  }\n  \n  // Motivos vÃ¡lidos para reembolso de suscripciÃ³n\n  const motivosValidos = [\n    \"indisponibilidad\",\n    \"problemas tÃ©cnicos\",\n    \"error de facturaciÃ³n\",\n    \"cargo duplicado\",\n    \"no funciona\",\n    \"caÃ­da\",\n    \"down\",\n    \"bug\"\n  ];\n  \n  const motivoValido = motivosValidos.some(motivo => \n    analisisIA.motivo_solicitud.toLowerCase().includes(motivo)\n  );\n  \n  // Verificar si fue reportado dentro de 30 dÃ­as\n  const dentroDeVentana = ultimoCargo.created > hace30Dias;\n  \n  if (motivoValido && dentroDeVentana) {\n    return {\n      ...analisisIA,\n      cumple_politica: true,\n      razon: `Motivo tÃ©cnico vÃ¡lido: ${analisisIA.motivo_solicitud}`,\n      customer_id: customer.id,\n      charge_ids: [ultimoCargo.id],\n      subscription_id: suscripcionActiva?.id,\n      monto_total: ultimoCargo.amount,\n      tipo: \"REEMBOLSO_SUSCRIPCION\"\n    };\n  } else {\n    return {\n      ...analisisIA,\n      cumple_politica: false,\n      razon: !motivoValido \n        ? \"Motivo no cumple con polÃ­tica de reembolsos\" \n        : \"Reporte fuera de ventana de 30 dÃ­as\",\n      customer_id: customer.id\n    };\n  }\n}\n\n// CASO 3: SOLO CANCELACIÃ“N (sin reembolso)\nif (analisisIA.tipo_solicitud === \"CANCELACION\") {\n  return {\n    ...analisisIA,\n    cumple_politica: false,\n    razon: \"Solicitud de cancelaciÃ³n (sin reembolso)\",\n    customer_id: customer.id,\n    subscription_id: suscripcionActiva?.id,\n    solo_cancelar: true\n  };\n}\n\n// DEFAULT: NO CUMPLE\nreturn {\n  ...analisisIA,\n  cumple_politica: false,\n  razon: \"No cumple con criterios de reembolso\",\n  customer_id: customer.id\n};"
        },
        "id": "node-evaluar-politica",
        "name": "âš–ï¸ Evaluar PolÃ­tica de Reembolso",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [1640, 100]
      },
      {
        "parameters": {
          "conditions": {
            "boolean": [
              {
                "value1": "={{ $json.cumple_politica }}",
                "value2": true
              }
            ]
          }
        },
        "id": "node-if-cumple-politica",
        "name": "ğŸ”€ Â¿Cumple PolÃ­tica?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 1,
        "position": [1840, 100]
      },
      {
        "parameters": {
          "jsCode": "// Procesar reembolso de cada cargo\nconst data = $input.item.json;\nconst chargeIds = data.charge_ids || [];\n\n// Crear array de promesas de reembolso\nconst reembolsos = [];\n\nfor (const chargeId of chargeIds) {\n  reembolsos.push({\n    charge_id: chargeId,\n    customer_id: data.customer_id,\n    monto: data.tipo === \"REEMBOLSO_INICIAL\" ? 50 : data.monto_total,\n    email: data.email_cliente\n  });\n}\n\nreturn reembolsos.map(r => ({ json: r }));"
        },
        "id": "node-preparar-reembolsos",
        "name": "ğŸ’³ Preparar Reembolsos",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [2040, 0]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.stripe.com/v1/refunds",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "stripeApi",
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "charge",
                "value": "={{ $json.charge_id }}"
              },
              {
                "name": "amount",
                "value": "={{ $json.monto }}"
              },
              {
                "name": "reason",
                "value": "requested_by_customer"
              },
              {
                "name": "metadata[email]",
                "value": "={{ $json.email }}"
              },
              {
                "name": "metadata[procesado_por]",
                "value": "n8n-agente-ia"
              }
            ]
          },
          "options": {}
        },
        "id": "node-crear-reembolso",
        "name": "ğŸ’° Stripe: Crear Reembolso",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4,
        "position": [2240, 0],
        "credentials": {
          "stripeApi": {
            "id": "3",
            "name": "Stripe API"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "string": [
              {
                "value1": "={{ $('âš–ï¸ Evaluar PolÃ­tica de Reembolso').item.json.subscription_id }}",
                "operation": "isNotEmpty"
              }
            ]
          }
        },
        "id": "node-if-tiene-suscripcion",
        "name": "ğŸ”€ Â¿Tiene SuscripciÃ³n Activa?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 1,
        "position": [2440, 0]
      },
      {
        "parameters": {
          "method": "DELETE",
          "url": "=https://api.stripe.com/v1/subscriptions/{{ $('âš–ï¸ Evaluar PolÃ­tica de Reembolso').item.json.subscription_id }}",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "stripeApi",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "invoice_now",
                "value": "false"
              }
            ]
          },
          "options": {}
        },
        "id": "node-cancelar-suscripcion",
        "name": "ğŸš« Stripe: Cancelar SuscripciÃ³n",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4,
        "position": [2640, -100],
        "credentials": {
          "stripeApi": {
            "id": "3",
            "name": "Stripe API"
          }
        }
      },
      {
        "parameters": {
          "fromEmail": "refunds@mindmetric.io",
          "toEmail": "={{ $('ğŸ“ Parsear Respuesta IA').item.json.email_cliente }}",
          "subject": "=Re: {{ $('ğŸ“§ Gmail: Recibir Solicitud').item.json.subject }}",
          "emailType": "html",
          "message": "=<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #113240 0%, #052547 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n    .content { background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; }\n    .success-box { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 20px 0; border-radius: 5px; }\n    .footer { background: #f8f9fa; padding: 20px; text-align: center; font-size: 12px; color: #666; border-radius: 0 0 10px 10px; }\n    .button { display: inline-block; background: #07C59A; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>âœ… Reembolso Procesado</h1>\n    </div>\n    <div class=\"content\">\n      <p>Hola,</p>\n      \n      <div class=\"success-box\">\n        <p><strong>âœ“ Tu reembolso ha sido procesado exitosamente</strong></p>\n      </div>\n      \n      <p>{{ $('ğŸ“ Parsear Respuesta IA').item.json.respuesta_sugerida }}</p>\n      \n      <p><strong>Detalles del reembolso:</strong></p>\n      <ul>\n        <li><strong>Monto:</strong> {{ $('âš–ï¸ Evaluar PolÃ­tica de Reembolso').item.json.monto_total / 100 }}â‚¬</li>\n        <li><strong>MÃ©todo:</strong> {{ $('âš–ï¸ Evaluar PolÃ­tica de Reembolso').item.json.tipo === 'REEMBOLSO_INICIAL' ? 'Pago inicial' : 'SuscripciÃ³n' }}</li>\n        <li><strong>Tiempo estimado:</strong> 3-5 dÃ­as hÃ¡biles</li>\n      </ul>\n      \n      <p>El reembolso se procesarÃ¡ al mismo mÃ©todo de pago que utilizaste originalmente.</p>\n      \n      <p>Si tienes alguna pregunta, no dudes en contactarnos.</p>\n      \n      <p>Gracias por tu comprensiÃ³n.</p>\n      \n      <p>Atentamente,<br><strong>Equipo de MindMetric</strong></p>\n    </div>\n    <div class=\"footer\">\n      <p>MindMetric | <a href=\"https://mindmetric.io\">mindmetric.io</a></p>\n      <p>Este es un email automÃ¡tico generado por nuestro sistema de IA.</p>\n    </div>\n  </div>\n</body>\n</html>",
          "options": {}
        },
        "id": "node-email-reembolso-aprobado",
        "name": "ğŸ“¤ Email: Reembolso Aprobado",
        "type": "n8n-nodes-base.emailSend",
        "typeVersion": 2,
        "position": [2840, 0],
        "credentials": {
          "smtp": {
            "id": "4",
            "name": "SendGrid SMTP"
          }
        }
      },
      {
        "parameters": {
          "fromEmail": "refunds@mindmetric.io",
          "toEmail": "={{ $('ğŸ“ Parsear Respuesta IA').item.json.email_cliente }}",
          "subject": "=Re: {{ $('ğŸ“§ Gmail: Recibir Solicitud').item.json.subject }}",
          "emailType": "html",
          "message": "=<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #113240 0%, #052547 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n    .content { background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; }\n    .info-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px; }\n    .footer { background: #f8f9fa; padding: 20px; text-align: center; font-size: 12px; color: #666; border-radius: 0 0 10px 10px; }\n    .button { display: inline-block; background: #07C59A; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>ğŸ“‹ Sobre tu Solicitud</h1>\n    </div>\n    <div class=\"content\">\n      <p>Hola,</p>\n      \n      <p>{{ $('ğŸ“ Parsear Respuesta IA').item.json.respuesta_sugerida }}</p>\n      \n      <div class=\"info-box\">\n        <p><strong>RazÃ³n:</strong> {{ $('âš–ï¸ Evaluar PolÃ­tica de Reembolso').item.json.razon }}</p>\n      </div>\n      \n      <p><strong>Nuestra polÃ­tica de reembolsos establece que:</strong></p>\n      <ul>\n        <li>Pago inicial (1â‚¬): Reembolsable dentro de 30 dÃ­as (primera vez)</li>\n        <li>Suscripciones: Solo por problemas tÃ©cnicos documentados o errores de facturaciÃ³n</li>\n        <li>Cambio de opiniÃ³n o no cancelar antes de renovaciÃ³n: No reembolsable</li>\n      </ul>\n      \n      {{ $('âš–ï¸ Evaluar PolÃ­tica de Reembolso').item.json.solo_cancelar ? '<p><strong>âœ… Hemos cancelado tu suscripciÃ³n</strong> para evitar futuros cargos. Puedes seguir usando el servicio hasta el final del perÃ­odo actual.</p>' : '' }}\n      \n      <p>Si crees que hay un error o tienes informaciÃ³n adicional, por favor responde a este correo.</p>\n      \n      <a href=\"https://mindmetric.io/es/reembolso\" class=\"button\" style=\"color: white;\">Ver PolÃ­tica Completa</a>\n      \n      <p>Gracias por tu comprensiÃ³n.</p>\n      \n      <p>Atentamente,<br><strong>Equipo de MindMetric</strong></p>\n    </div>\n    <div class=\"footer\">\n      <p>MindMetric | <a href=\"https://mindmetric.io\">mindmetric.io</a></p>\n      <p>Este es un email automÃ¡tico generado por nuestro sistema de IA.</p>\n    </div>\n  </div>\n</body>\n</html>",
          "options": {}
        },
        "id": "node-email-reembolso-denegado",
        "name": "ğŸ“¤ Email: Reembolso Denegado",
        "type": "n8n-nodes-base.emailSend",
        "typeVersion": 2,
        "position": [2840, 200],
        "credentials": {
          "smtp": {
            "id": "4",
            "name": "SendGrid SMTP"
          }
        }
      },
      {
        "parameters": {
          "fromEmail": "refunds@mindmetric.io",
          "toEmail": "={{ $('ğŸ“§ Gmail: Recibir Solicitud').item.json.from }}",
          "subject": "=Re: {{ $('ğŸ“§ Gmail: Recibir Solicitud').item.json.subject }}",
          "emailType": "html",
          "message": "=<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #113240 0%, #052547 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n    .content { background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; }\n    .warning-box { background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 20px 0; border-radius: 5px; }\n    .footer { background: #f8f9fa; padding: 20px; text-align: center; font-size: 12px; color: #666; border-radius: 0 0 10px 10px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>âŒ Cliente No Encontrado</h1>\n    </div>\n    <div class=\"content\">\n      <p>Hola,</p>\n      \n      <div class=\"warning-box\">\n        <p><strong>No encontramos tu cuenta en nuestro sistema.</strong></p>\n      </div>\n      \n      <p>Para procesar tu solicitud, necesitamos que verifiques la siguiente informaciÃ³n:</p>\n      <ul>\n        <li>Â¿Usaste este mismo email para registrarte?</li>\n        <li>Â¿El pago fue procesado correctamente?</li>\n        <li>Â¿Tienes el recibo de Stripe?</li>\n      </ul>\n      \n      <p>Por favor, responde a este correo con:</p>\n      <ol>\n        <li>El email usado en el pago</li>\n        <li>Fecha aproximada del pago</li>\n        <li>Captura del recibo (si la tienes)</li>\n      </ol>\n      \n      <p>Te ayudaremos a resolver esto lo antes posible.</p>\n      \n      <p>Atentamente,<br><strong>Equipo de MindMetric</strong></p>\n    </div>\n    <div class=\"footer\">\n      <p>MindMetric | <a href=\"https://mindmetric.io\">mindmetric.io</a></p>\n      <p>support@mindmetric.io</p>\n    </div>\n  </div>\n</body>\n</html>",
          "options": {}
        },
        "id": "node-email-no-encontrado",
        "name": "ğŸ“¤ Email: Cliente No Encontrado",
        "type": "n8n-nodes-base.emailSend",
        "typeVersion": 2,
        "position": [1640, 300],
        "credentials": {
          "smtp": {
            "id": "4",
            "name": "SendGrid SMTP"
          }
        }
      },
      {
        "parameters": {
          "fromEmail": "refunds@mindmetric.io",
          "toEmail": "={{ $('ğŸ“§ Gmail: Recibir Solicitud').item.json.from }}",
          "subject": "=Re: {{ $('ğŸ“§ Gmail: Recibir Solicitud').item.json.subject }}",
          "emailType": "html",
          "message": "=<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #113240 0%, #052547 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n    .content { background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; }\n    .footer { background: #f8f9fa; padding: 20px; text-align: center; font-size: 12px; color: #666; border-radius: 0 0 10px 10px; }\n    .button { display: inline-block; background: #07C59A; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>ğŸ‘‹ Gracias por Contactarnos</h1>\n    </div>\n    <div class=\"content\">\n      <p>Hola,</p>\n      \n      <p>{{ $('ğŸ“ Parsear Respuesta IA').item.json.respuesta_sugerida }}</p>\n      \n      <p>Si tu consulta es sobre reembolsos o cancelaciones, por favor especifÃ­calo claramente en tu respuesta.</p>\n      \n      <p><strong>Para reembolsos, incluye:</strong></p>\n      <ul>\n        <li>Email usado en el pago</li>\n        <li>Fecha del pago</li>\n        <li>Motivo del reembolso</li>\n      </ul>\n      \n      <a href=\"https://mindmetric.io/es/contacto\" class=\"button\" style=\"color: white;\">Formulario de Contacto</a>\n      \n      <p>Atentamente,<br><strong>Equipo de MindMetric</strong></p>\n    </div>\n    <div class=\"footer\">\n      <p>MindMetric | <a href=\"https://mindmetric.io\">mindmetric.io</a></p>\n      <p>support@mindmetric.io</p>\n    </div>\n  </div>\n</body>\n</html>",
          "options": {}
        },
        "id": "node-email-generico",
        "name": "ğŸ“¤ Email: Respuesta GenÃ©rica",
        "type": "n8n-nodes-base.emailSend",
        "typeVersion": 2,
        "position": [1240, 400],
        "credentials": {
          "smtp": {
            "id": "4",
            "name": "SendGrid SMTP"
          }
        }
      }
    ],
    "connections": {
      "ğŸ“§ Gmail: Recibir Solicitud": {
        "main": [
          [
            {
              "node": "ğŸ§  Prompt del Sistema",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ§  Prompt del Sistema": {
        "main": [
          [
            {
              "node": "ğŸ¤– OpenAI: Analizar Solicitud",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ¤– OpenAI: Analizar Solicitud": {
        "main": [
          [
            {
              "node": "ğŸ“ Parsear Respuesta IA",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ“ Parsear Respuesta IA": {
        "main": [
          [
            {
              "node": "ğŸ”€ Â¿Es Solicitud de Reembolso?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ”€ Â¿Es Solicitud de Reembolso?": {
        "main": [
          [
            {
              "node": "ğŸ” Stripe: Buscar Cliente",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "ğŸ“¤ Email: Respuesta GenÃ©rica",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ” Stripe: Buscar Cliente": {
        "main": [
          [
            {
              "node": "ğŸ”€ Â¿Cliente Existe en Stripe?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ”€ Â¿Cliente Existe en Stripe?": {
        "main": [
          [
            {
              "node": "âš–ï¸ Evaluar PolÃ­tica de Reembolso",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "ğŸ“¤ Email: Cliente No Encontrado",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "âš–ï¸ Evaluar PolÃ­tica de Reembolso": {
        "main": [
          [
            {
              "node": "ğŸ”€ Â¿Cumple PolÃ­tica?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ”€ Â¿Cumple PolÃ­tica?": {
        "main": [
          [
            {
              "node": "ğŸ’³ Preparar Reembolsos",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "ğŸ“¤ Email: Reembolso Denegado",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ’³ Preparar Reembolsos": {
        "main": [
          [
            {
              "node": "ğŸ’° Stripe: Crear Reembolso",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ’° Stripe: Crear Reembolso": {
        "main": [
          [
            {
              "node": "ğŸ”€ Â¿Tiene SuscripciÃ³n Activa?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸ”€ Â¿Tiene SuscripciÃ³n Activa?": {
        "main": [
          [
            {
              "node": "ğŸš« Stripe: Cancelar SuscripciÃ³n",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "ğŸ“¤ Email: Reembolso Aprobado",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ğŸš« Stripe: Cancelar SuscripciÃ³n": {
        "main": [
          [
            {
              "node": "ğŸ“¤ Email: Reembolso Aprobado",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "active": true,
    "settings": {
      "executionOrder": "v1"
    },
    "versionId": "1",
    "id": "mindmetric-refunds-agent",
    "meta": {
      "instanceId": "mindmetric-production"
    },
    "tags": []
  }

